name: Validate Apple Secrets

on:
  workflow_dispatch:

jobs:
  validate-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check eas.json Configuration
        run: |
          echo "=========================================="
          echo "Checking eas.json Configuration"
          echo "=========================================="
          echo ""

          if [ -f "eas.json" ]; then
            echo "‚úì eas.json found"
            echo ""
            echo "Submit configuration:"
            cat eas.json | grep -A 10 "submit"
            echo ""
          else
            echo "‚ùå eas.json not found"
            exit 1
          fi

      - name: Validate Secret Formats
        env:
          EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
          EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}
          EXPO_APPLE_TEAM_ID: ${{ secrets.EXPO_APPLE_TEAM_ID }}
          EXPO_ASC_APP_ID: ${{ secrets.EXPO_ASC_APP_ID }}
          EXPO_ASC_KEY_ID: ${{ secrets.EXPO_ASC_KEY_ID }}
          EXPO_ASC_ISSUER_ID: ${{ secrets.EXPO_ASC_ISSUER_ID }}
          EXPO_ASC_KEY_P8: ${{ secrets.EXPO_ASC_KEY_P8 }}
        run: |
          echo "=========================================="
          echo "Validating Apple Secrets Format"
          echo "=========================================="
          echo ""

          # Function to validate format
          validate_secret() {
            local name="$1"
            local value="$2"
            local pattern="$3"
            local example="$4"

            if [ -z "$value" ]; then
              echo "‚ùå $name: EMPTY or NOT SET"
              return 1
            fi

            local length=${#value}
            echo "‚úì $name: SET (length: $length characters)"

            if [[ ! "$value" =~ $pattern ]]; then
              echo "   ‚ö†Ô∏è  WARNING: Format may be incorrect"
              echo "   Expected format: $example"
              echo "   First 3 chars: ${value:0:3}..."
              return 1
            else
              echo "   ‚úÖ Format looks correct"
              return 0
            fi
          }

          VALID=true

          echo "=========================================="
          echo "Checking Authentication Method"
          echo "=========================================="
          echo ""

          # Check if ASC API Key method is configured
          if [ -n "$EXPO_ASC_KEY_ID" ] && [ -n "$EXPO_ASC_ISSUER_ID" ] && [ -n "$EXPO_ASC_KEY_P8" ]; then
            echo "üîë ASC API Key authentication detected"
            echo ""

            echo "1Ô∏è‚É£ Validating EXPO_ASC_KEY_ID"
            if validate_secret "EXPO_ASC_KEY_ID" "$EXPO_ASC_KEY_ID" "^[A-Z0-9]{10}$" "ABC123DEFG (10 alphanumeric)"; then
              echo ""
            else
              VALID=false
              echo ""
            fi

            echo "2Ô∏è‚É£ Validating EXPO_ASC_ISSUER_ID"
            if validate_secret "EXPO_ASC_ISSUER_ID" "$EXPO_ASC_ISSUER_ID" "^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$" "12345678-1234-1234-1234-123456789012 (UUID format)"; then
              echo ""
            else
              VALID=false
              echo ""
            fi

            echo "3Ô∏è‚É£ Validating EXPO_ASC_KEY_P8"
            if [ -z "$EXPO_ASC_KEY_P8" ]; then
              echo "‚ùå EXPO_ASC_KEY_P8: EMPTY or NOT SET"
              VALID=false
            else
              local length=${#EXPO_ASC_KEY_P8}
              echo "‚úì EXPO_ASC_KEY_P8: SET (length: $length characters)"
              if [[ "$EXPO_ASC_KEY_P8" == *"BEGIN PRIVATE KEY"* ]] && [[ "$EXPO_ASC_KEY_P8" == *"END PRIVATE KEY"* ]]; then
                echo "   ‚úÖ Contains BEGIN/END PRIVATE KEY markers"
              else
                echo "   ‚ö†Ô∏è  WARNING: Missing BEGIN/END PRIVATE KEY markers"
                echo "   Expected format: -----BEGIN PRIVATE KEY-----...-----END PRIVATE KEY-----"
                VALID=false
              fi
            fi
            echo ""

          elif [ -n "$EXPO_APPLE_ID" ] || [ -n "$EXPO_APPLE_APP_SPECIFIC_PASSWORD" ]; then
            echo "üìß Apple ID authentication detected"
            echo ""

            echo "1Ô∏è‚É£ Validating EXPO_APPLE_ID (Apple ID email)"
            if validate_secret "EXPO_APPLE_ID" "$EXPO_APPLE_ID" "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" "email@example.com"; then
              echo ""
            else
              VALID=false
              echo ""
            fi

            echo "2Ô∏è‚É£ Validating EXPO_APPLE_APP_SPECIFIC_PASSWORD"
            if [ -z "$EXPO_APPLE_APP_SPECIFIC_PASSWORD" ]; then
              echo "‚ùå EXPO_APPLE_APP_SPECIFIC_PASSWORD: EMPTY or NOT SET"
              VALID=false
            else
              local length=${#EXPO_APPLE_APP_SPECIFIC_PASSWORD}
              echo "‚úì EXPO_APPLE_APP_SPECIFIC_PASSWORD: SET (length: $length characters)"
              # Remove any dashes to check the actual character count
              local clean_password="${EXPO_APPLE_APP_SPECIFIC_PASSWORD//-/}"
              local clean_length=${#clean_password}
              echo "   Length without dashes: $clean_length characters"
              if [ $clean_length -eq 16 ]; then
                echo "   ‚úÖ Length is correct (16 characters without dashes)"
              else
                echo "   ‚ö†Ô∏è  WARNING: Length seems incorrect for app-specific password"
                echo "   Expected: 16 characters (format: xxxx-xxxx-xxxx-xxxx, shown without dashes in secrets)"
                VALID=false
              fi
            fi
            echo ""

            echo "3Ô∏è‚É£ Validating EXPO_APPLE_TEAM_ID"
            if validate_secret "EXPO_APPLE_TEAM_ID" "$EXPO_APPLE_TEAM_ID" "^[A-Z0-9]{10}$" "AB12CD34EF (10 uppercase alphanumeric)"; then
              echo ""
            else
              VALID=false
              echo ""
            fi

            echo "4Ô∏è‚É£ Validating EXPO_ASC_APP_ID"
            if validate_secret "EXPO_ASC_APP_ID" "$EXPO_ASC_APP_ID" "^[0-9]+$" "1234567891 (digits only)"; then
              echo ""
            else
              VALID=false
              echo ""
            fi

          else
            echo "‚ùå No authentication method configured!"
            echo ""
            echo "You must configure either:"
            echo "  A) ASC API Key (RECOMMENDED)"
            echo "     - EXPO_ASC_KEY_ID"
            echo "     - EXPO_ASC_ISSUER_ID"
            echo "     - EXPO_ASC_KEY_P8"
            echo ""
            echo "  B) Apple ID + App-Specific Password"
            echo "     - EXPO_APPLE_ID"
            echo "     - EXPO_APPLE_APP_SPECIFIC_PASSWORD"
            echo "     - EXPO_APPLE_TEAM_ID"
            echo "     - EXPO_ASC_APP_ID"
            VALID=false
          fi

          echo "=========================================="
          if [ "$VALID" = true ]; then
            echo "‚úÖ All secrets are set and formats look correct!"
            echo "=========================================="
            exit 0
          else
            echo "‚ùå Some secrets have issues - see warnings above"
            echo "=========================================="
            echo ""
            echo "To fix:"
            echo "1. Go to: https://github.com/ales27pm/monGARS_expo/settings/secrets/actions"
            echo "2. Update any secrets with warnings"
            echo ""
            echo "Where to find the correct values:"
            echo ""
            echo "METHOD A - ASC API Key (RECOMMENDED):"
            echo "- EXPO_ASC_KEY_ID: App Store Connect ‚Üí Users and Access ‚Üí Integrations ‚Üí Keys"
            echo "- EXPO_ASC_ISSUER_ID: App Store Connect ‚Üí Users and Access ‚Üí Integrations ‚Üí Issuer ID"
            echo "- EXPO_ASC_KEY_P8: Download .p8 file and copy entire contents including BEGIN/END lines"
            echo ""
            echo "METHOD B - Apple ID Authentication:"
            echo "- EXPO_APPLE_ID: Your Apple ID email"
            echo "- EXPO_APPLE_TEAM_ID: developer.apple.com/account ‚Üí Membership"
            echo "- EXPO_ASC_APP_ID: appstoreconnect.apple.com ‚Üí My Apps ‚Üí (your app) ‚Üí check URL"
            echo "- EXPO_APPLE_APP_SPECIFIC_PASSWORD: appleid.apple.com ‚Üí Security ‚Üí App-Specific Passwords"
            echo "  (Copy without dashes: xxxx-xxxx-xxxx-xxxx becomes xxxxxxxxxxxxxxxx)"
            exit 1
          fi
