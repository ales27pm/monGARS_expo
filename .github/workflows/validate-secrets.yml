name: Validate Apple Secrets

on:
  workflow_dispatch:

jobs:
  validate-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Validate Secret Formats
        env:
          EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
          EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}
          EXPO_APPLE_TEAM_ID: ${{ secrets.EXPO_APPLE_TEAM_ID }}
          EXPO_ASC_APP_ID: ${{ secrets.EXPO_ASC_APP_ID }}
        run: |
          echo "=========================================="
          echo "Validating Apple Secrets Format"
          echo "=========================================="
          echo ""

          # Function to validate format
          validate_secret() {
            local name="$1"
            local value="$2"
            local pattern="$3"
            local example="$4"

            if [ -z "$value" ]; then
              echo "❌ $name: EMPTY or NOT SET"
              return 1
            fi

            local length=${#value}
            echo "✓ $name: SET (length: $length characters)"

            if [[ ! "$value" =~ $pattern ]]; then
              echo "   ⚠️  WARNING: Format may be incorrect"
              echo "   Expected format: $example"
              echo "   First 3 chars: ${value:0:3}..."
              return 1
            else
              echo "   ✅ Format looks correct"
              return 0
            fi
          }

          VALID=true

          echo "1️⃣ Validating EXPO_APPLE_ID (Apple ID email)"
          if validate_secret "EXPO_APPLE_ID" "$EXPO_APPLE_ID" "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" "email@example.com"; then
            echo ""
          else
            VALID=false
            echo ""
          fi

          echo "2️⃣ Validating EXPO_APPLE_APP_SPECIFIC_PASSWORD"
          if [ -z "$EXPO_APPLE_APP_SPECIFIC_PASSWORD" ]; then
            echo "❌ EXPO_APPLE_APP_SPECIFIC_PASSWORD: EMPTY or NOT SET"
            VALID=false
          else
            local length=${#EXPO_APPLE_APP_SPECIFIC_PASSWORD}
            echo "✓ EXPO_APPLE_APP_SPECIFIC_PASSWORD: SET (length: $length characters)"
            if [ $length -ge 16 ] && [ $length -le 20 ]; then
              echo "   ✅ Length looks correct (app-specific passwords are typically 16-19 chars)"
            else
              echo "   ⚠️  WARNING: Length seems unusual for app-specific password"
              echo "   Expected: 16-19 characters (format: xxxx-xxxx-xxxx-xxxx)"
            fi
          fi
          echo ""

          echo "3️⃣ Validating EXPO_APPLE_TEAM_ID"
          if validate_secret "EXPO_APPLE_TEAM_ID" "$EXPO_APPLE_TEAM_ID" "^[A-Z0-9]{10}$" "AB12CD34EF (10 uppercase alphanumeric)"; then
            echo ""
          else
            VALID=false
            echo ""
          fi

          echo "4️⃣ Validating EXPO_ASC_APP_ID"
          if validate_secret "EXPO_ASC_APP_ID" "$EXPO_ASC_APP_ID" "^[0-9]+$" "1234567891 (digits only)"; then
            echo ""
          else
            VALID=false
            echo ""
          fi

          echo "=========================================="
          if [ "$VALID" = true ]; then
            echo "✅ All secrets are set and formats look correct!"
            echo "=========================================="
            exit 0
          else
            echo "❌ Some secrets have issues - see warnings above"
            echo "=========================================="
            echo ""
            echo "To fix:"
            echo "1. Go to: https://github.com/ales27pm/monGARS_expo/settings/secrets/actions"
            echo "2. Update any secrets with warnings"
            echo ""
            echo "Where to find the correct values:"
            echo "- EXPO_APPLE_ID: Your Apple ID email"
            echo "- EXPO_APPLE_TEAM_ID: developer.apple.com/account → Membership"
            echo "- EXPO_ASC_APP_ID: appstoreconnect.apple.com → My Apps → (your app) → check URL"
            echo "- EXPO_APPLE_APP_SPECIFIC_PASSWORD: appleid.apple.com → Security → App-Specific Passwords"
            exit 1
          fi
