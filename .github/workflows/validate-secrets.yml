name: Validate Apple Secrets

on:
  workflow_dispatch:

jobs:
  validate-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Expo EAS CLI
        run: npm install --global eas-cli@latest

      - name: Check eas.json Configuration
        run: |
          echo "=========================================="
          echo "Checking eas.json Configuration"
          echo "=========================================="
          echo ""

          if [ -f "eas.json" ]; then
            echo "‚úì eas.json found"
            echo ""
            echo "Submit configuration:"
            cat eas.json | grep -A 10 "submit"
            echo ""
          else
            echo "‚ùå eas.json not found"
            exit 1
          fi

      - name: Validate Secret Formats
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
          EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}
          EXPO_APPLE_TEAM_ID: ${{ secrets.EXPO_APPLE_TEAM_ID }}
          EXPO_ASC_APP_ID: ${{ secrets.EXPO_ASC_APP_ID }}
          EXPO_ASC_KEY_ID: ${{ secrets.EXPO_ASC_KEY_ID }}
          EXPO_ASC_ISSUER_ID: ${{ secrets.EXPO_ASC_ISSUER_ID }}
          EXPO_ASC_KEY_P8: ${{ secrets.EXPO_ASC_KEY_P8 }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          ASC_APP_ID: ${{ secrets.ASC_APP_ID }}
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APPSTORE_API_ISSUER_ID: ${{ secrets.APPSTORE_API_ISSUER_ID }}
          APPSTORE_API_PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
        run: |
          set -euo pipefail

          echo "=========================================="
          echo "Validating EAS and ASC Secrets"
          echo "=========================================="
          echo ""

          validate_secret() {
            local name="$1"
            local value="$2"
            local pattern="$3"
            local example="$4"

            if [ -z "$value" ]; then
              echo "‚ùå $name: EMPTY or NOT SET"
              return 1
            fi

            local length=${#value}
            echo "‚úì $name: SET (length: $length characters)"

            if [ -n "$pattern" ]; then
              if [[ "$value" =~ $pattern ]]; then
                echo "   ‚úÖ Format looks correct"
                return 0
              fi

              echo "   ‚ö†Ô∏è  WARNING: Format may be incorrect"
              if [ -n "$example" ]; then
                echo "   Expected format: $example"
              fi
              return 1
            fi

            return 0
          }

          check_dual_secret() {
            local label="$1"
            local primary_name="$2"
            local primary_value="$3"
            local fallback_name="$4"
            local fallback_value="$5"
            local pattern="$6"
            local example="$7"
            local optional="${8:-false}"

            local has_value=false
            local status=0

            if [ -n "$primary_value" ]; then
              has_value=true
              echo "‚Ä¢ $primary_name"
              if ! validate_secret "$primary_name" "$primary_value" "$pattern" "$example"; then
                status=1
              fi
            fi

            if [ -n "$fallback_value" ]; then
              has_value=true
              echo "‚Ä¢ $fallback_name"
              if ! validate_secret "$fallback_name" "$fallback_value" "$pattern" "$example"; then
                status=1
              fi
            fi

            if [ "$has_value" = false ]; then
              if [ "$optional" = true ]; then
                echo "‚ÑπÔ∏è  $label: Not provided (optional)."
                return 0
              fi

              echo "‚ùå $label: Provide $primary_name or $fallback_name."
              return 1
            fi

            return $status
          }

          check_dual_private_key() {
            local label="$1"
            local primary_name="$2"
            local primary_value="$3"
            local fallback_name="$4"
            local fallback_value="$5"

            local has_value=false
            local status=0

            if [ -n "$primary_value" ]; then
              has_value=true
              echo "‚Ä¢ $primary_name"
              if ! validate_secret "$primary_name" "$primary_value" "" ""; then
                status=1
              elif [[ "$primary_value" == *"BEGIN PRIVATE KEY"* ]] && [[ "$primary_value" == *"END PRIVATE KEY"* ]]; then
                echo "   ‚úÖ $primary_name contains PRIVATE KEY markers"
              else
                echo "   ‚ö†Ô∏è  WARNING: $primary_name missing PRIVATE KEY markers"
                echo "   Expected format: -----BEGIN PRIVATE KEY----- ... -----END PRIVATE KEY-----"
                status=1
              fi
            fi

            if [ -n "$fallback_value" ]; then
              has_value=true
              echo "‚Ä¢ $fallback_name"
              if ! validate_secret "$fallback_name" "$fallback_value" "" ""; then
                status=1
              elif [[ "$fallback_value" == *"BEGIN PRIVATE KEY"* ]] && [[ "$fallback_value" == *"END PRIVATE KEY"* ]]; then
                echo "   ‚úÖ $fallback_name contains PRIVATE KEY markers"
              else
                echo "   ‚ö†Ô∏è  WARNING: $fallback_name missing PRIVATE KEY markers"
                echo "   Expected format: -----BEGIN PRIVATE KEY----- ... -----END PRIVATE KEY-----"
                status=1
              fi
            fi

            if [ "$has_value" = false ]; then
              echo "‚ùå $label: Provide $primary_name or $fallback_name."
              return 1
            fi

            return $status
          }

          check_app_specific_password() {
            local primary_name="$1"
            local primary_value="$2"
            local fallback_name="$3"
            local fallback_value="$4"

            local has_value=false
            local status=0

            if [ -n "$primary_value" ]; then
              has_value=true
              echo "‚Ä¢ $primary_name"
              if ! validate_secret "$primary_name" "$primary_value" "" ""; then
                status=1
              else
                local clean_password="${primary_value//-/}"
                local clean_length=${#clean_password}
                if [ "$clean_length" -eq 16 ]; then
                  echo "   ‚úÖ $primary_name length is correct (16 characters without dashes)"
                else
                  echo "   ‚ö†Ô∏è  WARNING: $primary_name should contain 16 characters (format xxxx-xxxx-xxxx-xxxx without dashes)"
                  status=1
                fi
              fi
            fi

            if [ -n "$fallback_value" ]; then
              has_value=true
              echo "‚Ä¢ $fallback_name"
              if ! validate_secret "$fallback_name" "$fallback_value" "" ""; then
                status=1
              else
                local clean_password="${fallback_value//-/}"
                local clean_length=${#clean_password}
                if [ "$clean_length" -eq 16 ]; then
                  echo "   ‚úÖ $fallback_name length is correct (16 characters without dashes)"
                else
                  echo "   ‚ö†Ô∏è  WARNING: $fallback_name should contain 16 characters (format xxxx-xxxx-xxxx-xxxx without dashes)"
                  status=1
                fi
              fi
            fi

            if [ "$has_value" = false ]; then
              echo "‚ùå Apple app-specific password missing. Provide $primary_name or $fallback_name."
              return 1
            fi

            return $status
          }

          VALID=true

          echo "=========================================="
          echo "Checking Expo (EAS) authentication"
          echo "=========================================="
          echo ""

          if validate_secret "EXPO_TOKEN" "${EXPO_TOKEN:-}" ".+" "Non-empty token"; then
            set +e
            whoami_output=$(eas whoami 2>&1)
            whoami_status=$?
            set -e
            if [ "$whoami_status" -eq 0 ]; then
              echo "   ‚úÖ eas whoami succeeded: $(echo "$whoami_output" | head -n 1)"
            else
              echo "   ‚ùå eas whoami failed. Verify EXPO_TOKEN is valid."
              echo "$whoami_output"
              VALID=false
            fi
          else
            VALID=false
          fi

          echo ""
          echo "=========================================="
          echo "Checking App Store Connect authentication"
          echo "=========================================="
          echo ""

          API_KEY_CONFIGURED=false
          if [ -n "${EXPO_ASC_KEY_ID:-}" ] || [ -n "${APPSTORE_API_KEY_ID:-}" ] || [ -n "${EXPO_ASC_ISSUER_ID:-}" ] || [ -n "${APPSTORE_API_ISSUER_ID:-}" ] || [ -n "${EXPO_ASC_KEY_P8:-}" ] || [ -n "${APPSTORE_API_PRIVATE_KEY:-}" ]; then
            API_KEY_CONFIGURED=true
            echo "üîë App Store Connect API key detected"
            if ! check_dual_secret "App Store Connect Key ID" "EXPO_ASC_KEY_ID" "${EXPO_ASC_KEY_ID:-}" "APPSTORE_API_KEY_ID" "${APPSTORE_API_KEY_ID:-}" '^[A-Z0-9]{10}$' "AB12CD34EF"; then
              VALID=false
            fi
            if ! check_dual_secret "App Store Connect Issuer ID" "EXPO_ASC_ISSUER_ID" "${EXPO_ASC_ISSUER_ID:-}" "APPSTORE_API_ISSUER_ID" "${APPSTORE_API_ISSUER_ID:-}" '^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$' "12345678-1234-1234-1234-123456789012"; then
              VALID=false
            fi
            if ! check_dual_private_key "App Store Connect API Key" "EXPO_ASC_KEY_P8" "${EXPO_ASC_KEY_P8:-}" "APPSTORE_API_PRIVATE_KEY" "${APPSTORE_API_PRIVATE_KEY:-}"; then
              VALID=false
            fi
          else
            echo "‚ÑπÔ∏è  No App Store Connect API key secrets provided."
          fi

          APPLE_ID_CONFIGURED=false
          if [ -n "${EXPO_APPLE_ID:-}" ] || [ -n "${APPLE_ID:-}" ] || [ -n "${EXPO_APPLE_APP_SPECIFIC_PASSWORD:-}" ] || [ -n "${APPLE_APP_SPECIFIC_PASSWORD:-}" ]; then
            APPLE_ID_CONFIGURED=true
            echo "üìß Apple ID authentication detected"
            if ! check_dual_secret "Apple ID email" "EXPO_APPLE_ID" "${EXPO_APPLE_ID:-}" "APPLE_ID" "${APPLE_ID:-}" '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' "email@example.com"; then
              VALID=false
            fi
            if ! check_app_specific_password "EXPO_APPLE_APP_SPECIFIC_PASSWORD" "${EXPO_APPLE_APP_SPECIFIC_PASSWORD:-}" "APPLE_APP_SPECIFIC_PASSWORD" "${APPLE_APP_SPECIFIC_PASSWORD:-}"; then
              VALID=false
            fi
            if ! check_dual_secret "Apple Team ID" "EXPO_APPLE_TEAM_ID" "${EXPO_APPLE_TEAM_ID:-}" "APPLE_TEAM_ID" "${APPLE_TEAM_ID:-}" '^[A-Z0-9]{10}$' "AB12CD34EF"; then
              VALID=false
            fi
          else
            echo "‚ÑπÔ∏è  No Apple ID secrets provided."
          fi

          if [ "$API_KEY_CONFIGURED" = false ] && [ "$APPLE_ID_CONFIGURED" = false ]; then
            echo "‚ùå No App Store Connect authentication secrets detected. Configure either API key credentials or Apple ID secrets."
            VALID=false
          fi

          if ! check_dual_secret "App Store Connect App ID" "EXPO_ASC_APP_ID" "${EXPO_ASC_APP_ID:-}" "ASC_APP_ID" "${ASC_APP_ID:-}" '^[0-9]+$' "123456789"; then
            VALID=false
          fi

          echo ""
          echo "=========================================="
          if [ "$VALID" = true ]; then
            echo "‚úÖ All secrets are set and validated successfully!"
            echo "=========================================="
            exit 0
          fi

          echo "‚ùå Some secrets have issues - see warnings above"
          echo "=========================================="
          echo ""
          echo "To fix:"
          echo "1. Go to: https://github.com/ales27pm/monGARS_expo/settings/secrets/actions"
          echo "2. Update any secrets with warnings"
          echo ""
          echo "Where to find the correct values:"
          echo ""
          echo "METHOD A - ASC API Key (RECOMMENDED):"
          echo "- EXPO_ASC_KEY_ID or APPSTORE_API_KEY_ID: App Store Connect ‚Üí Users and Access ‚Üí Integrations ‚Üí Keys"
          echo "- EXPO_ASC_ISSUER_ID or APPSTORE_API_ISSUER_ID: App Store Connect ‚Üí Users and Access ‚Üí Integrations ‚Üí Issuer ID"
          echo "- EXPO_ASC_KEY_P8 or APPSTORE_API_PRIVATE_KEY: Download .p8 file and copy entire contents including BEGIN/END lines"
          echo ""
          echo "METHOD B - Apple ID Authentication:"
          echo "- EXPO_APPLE_ID or APPLE_ID: Your Apple ID email"
          echo "- EXPO_APPLE_TEAM_ID or APPLE_TEAM_ID: developer.apple.com/account ‚Üí Membership"
          echo "- EXPO_ASC_APP_ID or ASC_APP_ID: appstoreconnect.apple.com ‚Üí My Apps ‚Üí (your app) ‚Üí check URL"
          echo "- EXPO_APPLE_APP_SPECIFIC_PASSWORD or APPLE_APP_SPECIFIC_PASSWORD: appleid.apple.com ‚Üí Security ‚Üí App-Specific Passwords"
          echo "  (Copy without dashes: xxxx-xxxx-xxxx-xxxx becomes xxxxxxxxxxxxxxxx)"
          exit 1
