name: Build iOS with Xcode (No EAS)

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Model to download and include'
        required: true
        default: 'qwen2-0.5b'
        type: choice
        options:
          - qwen2-0.5b
          - llama-3.2-1b
          - smollm2-1.7b
          - phi-3-mini
          - all
          - none
      scheme:
        description: 'Xcode scheme to build (leave empty for auto-detect)'
        required: false
        default: ''
        type: string
      configuration:
        description: 'Build configuration'
        required: false
        default: 'Release'
        type: choice
        options:
          - Debug
          - Release

env:
  MODELS_DIR: ./assets/models

jobs:
  build-with-xcode:
    name: Build iOS App with Xcode
    runs-on: macos-14
    timeout-minutes: 90

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üçé System Information
        run: |
          echo "üñ•Ô∏è macOS Version:"
          sw_vers
          echo ""
          echo "üíª Hardware:"
          sysctl hw.model hw.machine hw.ncpu hw.memsize
          echo ""
          echo "üõ†Ô∏è Xcode Version:"
          xcodebuild -version
          xcode-select --print-path
          echo ""
          echo "üì± Available iOS SDKs:"
          xcodebuild -showsdks | grep iOS

      - name: üêç Setup Python for model downloads
        if: ${{ inputs.model_name != 'none' }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Install Python dependencies
        if: ${{ inputs.model_name != 'none' }}
        run: |
          pip3 install huggingface-hub requests tqdm

      - name: üìÅ Create models directory
        if: ${{ inputs.model_name != 'none' }}
        run: |
          mkdir -p ${{ env.MODELS_DIR }}

      - name: ‚¨áÔ∏è Download Qwen2 0.5B Instruct
        if: ${{ inputs.model_name == 'qwen2-0.5b' || inputs.model_name == 'all' }}
        run: |
          python3 - <<'EOF'
          from huggingface_hub import hf_hub_download
          import os
          print("üì• Downloading Qwen2 0.5B Instruct Q4_K_M...")
          file_path = hf_hub_download(
              repo_id="Qwen/Qwen2-0.5B-Instruct-GGUF",
              filename="qwen2-0_5b-instruct-q4_k_m.gguf",
              local_dir="${{ env.MODELS_DIR }}",
              local_dir_use_symlinks=False
          )
          print(f"‚úÖ Downloaded to: {file_path}")
          print(f"üìä Size: {os.path.getsize(file_path) / (1024*1024):.2f} MB")
          EOF

      - name: ‚¨áÔ∏è Download Llama 3.2 1B Instruct
        if: ${{ inputs.model_name == 'llama-3.2-1b' || inputs.model_name == 'all' }}
        run: |
          python3 - <<'EOF'
          from huggingface_hub import hf_hub_download
          import os
          print("üì• Downloading Llama 3.2 1B Instruct Q4_K_M...")
          file_path = hf_hub_download(
              repo_id="ggml-org/Llama-3.2-1B-Instruct-GGUF",
              filename="Llama-3.2-1B-Instruct-Q4_K_M.gguf",
              local_dir="${{ env.MODELS_DIR }}",
              local_dir_use_symlinks=False
          )
          print(f"‚úÖ Downloaded to: {file_path}")
          print(f"üìä Size: {os.path.getsize(file_path) / (1024*1024):.2f} MB")
          EOF

      - name: ‚¨áÔ∏è Download SmolLM2 1.7B Instruct
        if: ${{ inputs.model_name == 'smollm2-1.7b' || inputs.model_name == 'all' }}
        run: |
          python3 - <<'EOF'
          from huggingface_hub import hf_hub_download
          import os
          print("üì• Downloading SmolLM2 1.7B Instruct Q4_K_M...")
          file_path = hf_hub_download(
              repo_id="HuggingFaceTB/SmolLM2-1.7B-Instruct-GGUF",
              filename="smollm2-1.7b-instruct-q4_k_m.gguf",
              local_dir="${{ env.MODELS_DIR }}",
              local_dir_use_symlinks=False
          )
          print(f"‚úÖ Downloaded to: {file_path}")
          print(f"üìä Size: {os.path.getsize(file_path) / (1024*1024):.2f} MB")
          EOF

      - name: ‚¨áÔ∏è Download Phi-3 Mini 3.8B
        if: ${{ inputs.model_name == 'phi-3-mini' || inputs.model_name == 'all' }}
        run: |
          python3 - <<'EOF'
          from huggingface_hub import hf_hub_download
          import os
          print("üì• Downloading Phi-3 Mini 4K Instruct Q4...")
          file_path = hf_hub_download(
              repo_id="microsoft/Phi-3-mini-4k-instruct-gguf",
              filename="Phi-3-mini-4k-instruct-q4.gguf",
              local_dir="${{ env.MODELS_DIR }}",
              local_dir_use_symlinks=False
          )
          print(f"‚úÖ Downloaded to: {file_path}")
          print(f"üìä Size: {os.path.getsize(file_path) / (1024*1024):.2f} MB")
          EOF

      - name: üìä Verify downloaded models
        if: ${{ inputs.model_name != 'none' }}
        run: |
          echo "üìÅ Downloaded models:"
          ls -lh ${{ env.MODELS_DIR }} || echo "No models downloaded"
          if [ -d "${{ env.MODELS_DIR }}" ]; then
            echo ""
            echo "üíæ Total size:"
            du -sh ${{ env.MODELS_DIR }}
          fi

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: üì¶ Install JavaScript dependencies
        run: |
          echo "üì¶ Installing dependencies with bun..."
          bun install --frozen-lockfile
          echo "‚úÖ Dependencies installed"

      - name: üèóÔ∏è Run Expo Prebuild
        run: |
          echo "üèóÔ∏è Running expo prebuild to generate iOS project..."
          npx expo prebuild --platform ios --clean
          echo "‚úÖ iOS project generated"

      - name: üì¶ Install CocoaPods dependencies
        run: |
          echo "üì¶ Installing CocoaPods dependencies..."
          cd ios
          pod install
          echo "‚úÖ Pods installed"

      - name: üìã List available schemes
        run: |
          echo "üìã Available Xcode schemes:"
          cd ios
          xcodebuild -list -workspace *.xcworkspace

      - name: üîç Detect scheme name
        id: detect_scheme
        run: |
          cd ios
          if [ -n "${{ inputs.scheme }}" ]; then
            SCHEME="${{ inputs.scheme }}"
            echo "Using provided scheme: $SCHEME"
          else
            # Get the project/app name from app.json
            APP_NAME=$(grep -o '"name"[[:space:]]*:[[:space:]]*"[^"]*"' ../app.json | head -1 | sed 's/"name"[[:space:]]*:[[:space:]]*"\([^"]*\)"/\1/')
            echo "App name from app.json: $APP_NAME"

            # List all schemes
            ALL_SCHEMES=$(xcodebuild -list -workspace *.xcworkspace 2>&1 | grep -A 200 "Schemes:" | grep -v "Schemes:" | sed 's/^[[:space:]]*//')
            echo "All schemes found:"
            echo "$ALL_SCHEMES"
            echo ""

            # Try to find scheme that matches the workspace/project name
            WORKSPACE_NAME=$(basename *.xcworkspace .xcworkspace)
            echo "Looking for scheme matching: $WORKSPACE_NAME"

            SCHEME=$(echo "$ALL_SCHEMES" | grep "^${WORKSPACE_NAME}$" | head -n 1)

            if [ -z "$SCHEME" ]; then
              echo "‚ö†Ô∏è Exact match not found, filtering out libraries..."
              # Filter out known library schemes
              SCHEME=$(echo "$ALL_SCHEMES" | \
                grep -v "^Pods-" | \
                grep -v "^boost" | \
                grep -v "^React" | \
                grep -v "^RN" | \
                grep -v "^Expo" | \
                grep -v "^EX" | \
                grep -v "^RCT" | \
                grep -v "^Yoga$" | \
                grep -v "^fmt$" | \
                grep -v "^glog" | \
                grep -v "^hermes" | \
                grep -v "^libavif" | \
                grep -v "^libdav1d" | \
                grep -v "^libwebp" | \
                grep -v "^lottie" | \
                grep -v "^SDWebImage" | \
                grep -v "^SocketRocket" | \
                grep -v "^fast_float" | \
                grep -v "^FBLazyVector" | \
                grep -v "^Galeria" | \
                grep -v "^ComputableLayout" | \
                grep -v "^ContextMenu" | \
                grep -v "^DGSwiftUtilities" | \
                grep -v "^DoubleConversion" | \
                grep -v "^EASClient" | \
                grep -v "^llama-rn" | \
                grep -v "react-native" | \
                grep -v "ReactAppDependency" | \
                grep -v "ReactCodegen" | \
                grep -v "ReactCommon" | \
                head -n 1)
            fi

            if [ -z "$SCHEME" ]; then
              echo "‚ùå Could not auto-detect scheme"
              echo "Available schemes:"
              echo "$ALL_SCHEMES"
              echo ""
              echo "Please provide scheme manually using the 'scheme' input parameter"
              exit 1
            fi

            echo "Auto-detected scheme: $SCHEME"
          fi
          echo "scheme=$SCHEME" >> $GITHUB_OUTPUT
          echo "‚úÖ Using scheme: $SCHEME"

      - name: üîë Setup signing (if credentials provided)
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_PROVISIONING_PROFILE: ${{ secrets.APPLE_PROVISIONING_PROFILE }}
        run: |
          if [ -n "$APPLE_CERTIFICATE" ] && [ -n "$APPLE_CERTIFICATE_PASSWORD" ]; then
            echo "üîë Setting up code signing..."

            # Create keychain
            security create-keychain -p actions build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p actions build.keychain
            security set-keychain-settings -t 3600 -u build.keychain

            # Import certificate
            echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
            security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
            security set-key-partition-list -S apple-tool:,apple: -s -k actions build.keychain

            # Import provisioning profile
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            echo "$APPLE_PROVISIONING_PROFILE" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

            echo "‚úÖ Code signing configured"
          else
            echo "‚ö†Ô∏è No signing credentials provided, will build for simulator only"
          fi

      - name: üèóÔ∏è Build with Xcode
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        run: |
          echo "üöÄ Building iOS app with Xcode..."
          cd ios

          # Find the workspace
          WORKSPACE=$(find . -name "*.xcworkspace" | head -n 1)
          echo "üìÅ Workspace: $WORKSPACE"

          # Use detected scheme
          SCHEME="${{ steps.detect_scheme.outputs.scheme }}"
          echo "üì± Scheme: $SCHEME"

          # Check if we have signing credentials
          if [ -n "$APPLE_CERTIFICATE" ]; then
            echo "üîê Building with code signing"
            # Build with signing
            xcodebuild \
              -workspace "$WORKSPACE" \
              -scheme "$SCHEME" \
              -configuration "${{ inputs.configuration }}" \
              -sdk iphoneos \
              -destination generic/platform=iOS \
              -archivePath "./build/App.xcarchive" \
              archive \
              -allowProvisioningUpdates
          else
            echo "‚ö†Ô∏è Building without code signing (simulator only)"
            # Build for simulator without signing
            xcodebuild \
              -workspace "$WORKSPACE" \
              -scheme "$SCHEME" \
              -configuration "${{ inputs.configuration }}" \
              -sdk iphonesimulator \
              -destination "generic/platform=iOS Simulator" \
              -archivePath "./build/App.xcarchive" \
              archive \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO
          fi

          echo "‚úÖ Archive created successfully"

      - name: üì¶ Export Archive to IPA
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        run: |
          if [ -n "$APPLE_CERTIFICATE" ]; then
            echo "üì¶ Exporting archive to IPA..."
            cd ios

            # Create export options plist
            cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          EOF

            # Export the archive
            xcodebuild \
              -exportArchive \
              -archivePath "./build/App.xcarchive" \
              -exportPath "./build" \
              -exportOptionsPlist ExportOptions.plist \
              -allowProvisioningUpdates

            echo "‚úÖ IPA exported successfully"
          else
            echo "‚ö†Ô∏è Skipping IPA export (no signing credentials)"
          fi

      - name: üì¶ Create simulator build
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "üì¶ Creating simulator build (no signing credentials)..."
            cd ios/build/App.xcarchive/Products/Applications
            zip -r ../../../../../App-Simulator.zip *.app
            echo "‚úÖ Simulator build created"
          else
            echo "‚ö†Ô∏è Skipping simulator build (signed IPA created instead)"
          fi

      - name: üìä Build artifacts info
        run: |
          echo "üìä Build artifacts:"
          ls -lh ios/build/
          if [ -f "ios/build/*.ipa" ]; then
            IPA_SIZE=$(du -h ios/build/*.ipa | cut -f1)
            echo "üì¶ IPA Size: $IPA_SIZE"
          fi

      - name: üì§ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-${{ inputs.configuration }}
          path: |
            ios/build/*.ipa
            ios/App-Simulator.zip
            ios/build/App.xcarchive
          if-no-files-found: warn
          retention-days: 30

      - name: üíæ Commit models to repository
        if: ${{ inputs.model_name != 'none' }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ${{ env.MODELS_DIR }}
          git add -A
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            git commit -m "Add ML models from Xcode build - Model: ${{ inputs.model_name }}"
            git push
            echo "‚úÖ Models committed and pushed"
          fi

      - name: ‚úÖ Build Summary
        if: always()
        run: |
          echo "================================================"
          echo "üéâ XCODE BUILD COMPLETE"
          echo "================================================"
          echo ""
          echo "üñ•Ô∏è Built on: macOS-14 GitHub Runner"
          echo "üõ†Ô∏è Tool: Xcode (Native Build)"
          echo "üì¶ Model: ${{ inputs.model_name }}"
          echo "üîß Configuration: ${{ inputs.configuration }}"
          echo "üì± Scheme: ${{ steps.detect_scheme.outputs.scheme }}"
          echo ""
          echo "üì• Download the IPA from the Actions artifacts"
          echo "   Go to: Actions ‚Üí This workflow run ‚Üí Artifacts"
          echo ""
          echo "================================================"

      - name: üí¨ Create build summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## üéâ Xcode Build Complete

          **Status:** ‚úÖ Build finished on macOS runner
          **Model:** ${{ inputs.model_name }}
          **Configuration:** ${{ inputs.configuration }}
          **Scheme:** ${{ steps.detect_scheme.outputs.scheme }}

          ### üèóÔ∏è Build Details
          - Built on: macOS-14 GitHub Runner
          - Xcode: $(xcodebuild -version | head -n 1)
          - Native compilation: All native modules compiled with Xcode
          - Build system: Xcode (No EAS)

          ### üì• Download IPA
          The built IPA file is available as a workflow artifact. Download it from the "Artifacts" section above.

          ### üì± Install on Device
          1. Download the IPA artifact
          2. Use Xcode or a tool like [iOS App Signer](https://dantheman827.github.io/ios-app-signer/)
          3. Sign with your developer certificate
          4. Install via Xcode or TestFlight

          ### üîó Useful Links
          - [Repository](https://github.com/${{ github.repository }})
          - [Actions](${{ github.server_url }}/${{ github.repository }}/actions)

          ---
          *Built with Xcode on GitHub Actions - 100% Free, No EAS Required*
          EOF

      - name: üì§ Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-xcode
          path: |
            **/*.log
            ios/build/
            .expo/
          if-no-files-found: warn
          retention-days: 7
