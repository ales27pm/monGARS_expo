name: Build & Deploy on macOS Runner

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: "Build configuration"
        required: false
        default: "Release"
        type: choice
        options:
          - Debug
          - Release
      submit_to_app_store:
        description: "Submit to App Store after build"
        required: false
        type: boolean
        default: false

jobs:
  build-with-native-modules:
    name: Build iOS with Native Turbo Modules
    runs-on: macos-15
    timeout-minutes: 90
    env:
      APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE || secrets.IOS_P12_BASE64 }}
      APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD || secrets.IOS_P12_PASSWORD }}
      APPLE_PROVISIONING_PROFILE: ${{ secrets.APPLE_PROVISIONING_PROFILE || secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      APPLE_ID: ${{ secrets.APPLE_ID || secrets.EXPO_APPLE_ID }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID || secrets.EXPO_APPLE_TEAM_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD || secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}
      APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID || secrets.EXPO_APPSTORE_API_KEY_ID }}
      APPSTORE_API_ISSUER_ID: ${{ secrets.APPSTORE_API_ISSUER_ID || secrets.EXPO_APPSTORE_API_ISSUER_ID }}
      APPSTORE_API_PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY || secrets.EXPO_APPSTORE_API_PRIVATE_KEY }}
      ASC_APP_ID: ${{ secrets.ASC_APP_ID || secrets.EXPO_ASC_APP_ID }}
      EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
      EXPO_APPLE_TEAM_ID: ${{ secrets.EXPO_APPLE_TEAM_ID }}
      EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}
      EXPO_ASC_APP_ID: ${{ secrets.EXPO_ASC_APP_ID }}
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      GH_PAT: ${{ secrets.GH_PAT }}
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîß Select Xcode 16.2
        run: |
          echo "Selecting Xcode 16.2 for iOS 18 SDK support..."
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
          echo "‚úÖ Xcode 16.2 selected"

      - name: üçé System Information
        run: |
          echo "üñ•Ô∏è macOS Version:"
          sw_vers
          echo ""
          echo "üíª Hardware:"
          sysctl hw.model hw.machine hw.ncpu hw.memsize
          echo ""
          echo "üõ†Ô∏è Xcode Version:"
          xcodebuild -version
          xcode-select --print-path
          echo ""
          echo "üì± Available iOS SDKs:"
          xcodebuild -showsdks | grep iOS

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: üì¶ Install JavaScript dependencies
        run: |
          echo "üì¶ Installing dependencies with bun..."
          bun install --frozen-lockfile
          echo "‚úÖ Dependencies installed"

      - name: üèóÔ∏è Run Expo Prebuild
        run: |
          echo "üèóÔ∏è Running expo prebuild to generate/update iOS project..."
          npx expo prebuild --platform ios --clean
          echo "‚úÖ iOS project generated with native modules"

      - name: üìã Verify Native Modules
        run: |
          set -euo pipefail

          echo "üìã Checking for native modules..."

          MODULE_DIRS=()
          while IFS= read -r dir; do
            if [ -n "$dir" ]; then
              MODULE_DIRS+=("$dir")
            fi
          done < <(find ios -maxdepth 2 -type d -name NativeModules | sort)

          if [ ${#MODULE_DIRS[@]} -eq 0 ]; then
            echo "‚ö†Ô∏è No NativeModules directories detected under ios/."
            echo "Skipping native module listing."
            exit 0
          fi

          for MODULES_DIR in "${MODULE_DIRS[@]}"; do
            PROJECT_NAME=$(basename "$(dirname "$MODULES_DIR")")
            echo "üìÅ Project: $PROJECT_NAME"
            ls -la "$MODULES_DIR"
            echo ""
            echo "Native modules found in $MODULES_DIR:"
            find "$MODULES_DIR" -type f \( -name "*.mm" -o -name "*.h" \ ) | sort || echo "(none)"
            echo ""
          done

      - name: üì¶ Install CocoaPods dependencies
        run: |
          echo "üì¶ Installing CocoaPods dependencies..."
          cd ios
          pod install
          echo "‚úÖ Pods installed"

      - name: üìã List available schemes
        run: |
          echo "üìã Available Xcode schemes:"
          cd ios
          xcodebuild -list -workspace *.xcworkspace

      - name: üîç Detect scheme name
        id: detect_scheme
        run: |
          cd ios
          WORKSPACE_NAME=$(basename *.xcworkspace .xcworkspace)
          echo "Using scheme: $WORKSPACE_NAME"
          echo "scheme=$WORKSPACE_NAME" >> $GITHUB_OUTPUT

      - name: üîë Setup signing (if credentials provided)
        id: setup_signing
        run: |
          set -euo pipefail

          if [ -n "$APPLE_CERTIFICATE" ] && [ -n "$APPLE_CERTIFICATE_PASSWORD" ]; then
            echo "üîë Setting up code signing..."

            WORK_KEYCHAIN="build.keychain"
            WORK_KEYCHAIN_PATH="$HOME/Library/Keychains/${WORK_KEYCHAIN}-db"
            PROFILE_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
            PROFILE_PATH="$PROFILE_DIR/profile.mobileprovision"

            ORIGINAL_KEYCHAIN=$(security default-keychain -d user | tr -d '"')
            security create-keychain -p actions "$WORK_KEYCHAIN"
            security default-keychain -s "$WORK_KEYCHAIN"
            security unlock-keychain -p actions "$WORK_KEYCHAIN"
            security set-keychain-settings -t 3600 -u "$WORK_KEYCHAIN"
            EXISTING_KEYCHAINS_FILE=$(mktemp)
            security list-keychains -d user | tr -d '"' | sed 's/^ *//' > "$EXISTING_KEYCHAINS_FILE"
            EXISTING_KEYCHAINS=()
            while IFS= read -r keychain; do
              if [ -n "$keychain" ]; then
                EXISTING_KEYCHAINS+=("$keychain")
              fi
            done < "$EXISTING_KEYCHAINS_FILE"
            rm -f "$EXISTING_KEYCHAINS_FILE"

            if [ "${#EXISTING_KEYCHAINS[@]}" -gt 0 ]; then
              security list-keychain -d user -s "$WORK_KEYCHAIN_PATH" "${EXISTING_KEYCHAINS[@]}"
            else
              security list-keychain -d user -s "$WORK_KEYCHAIN_PATH"
            fi

            CERTIFICATE_PATH=$(mktemp)
            echo "$APPLE_CERTIFICATE" | base64 --decode > "$CERTIFICATE_PATH"
            security import "$CERTIFICATE_PATH" -k "$WORK_KEYCHAIN" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security -A >/tmp/codesign-import.log 2>&1
            security set-key-partition-list -S apple-tool:,apple: -s -k actions "$WORK_KEYCHAIN"

            mkdir -p "$PROFILE_DIR"
            echo "$APPLE_PROVISIONING_PROFILE" | base64 --decode > "$PROFILE_PATH"

            PROFILE_PLIST=$(mktemp)
            trap 'rm -f "$CERTIFICATE_PATH" "$PROFILE_PLIST"; security default-keychain -d user -s "$ORIGINAL_KEYCHAIN" 2>/dev/null || true; security delete-keychain "$WORK_KEYCHAIN" 2>/dev/null || true' EXIT
            security cms -D -i "$PROFILE_PATH" > "$PROFILE_PLIST"

            TEAM_ID=$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' "$PROFILE_PLIST" 2>/dev/null || true)
            PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' "$PROFILE_PLIST" 2>/dev/null || true)
            PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$PROFILE_PLIST" 2>/dev/null || true)
            APP_IDENTIFIER=$(/usr/libexec/PlistBuddy -c 'Print :Entitlements:application-identifier' "$PROFILE_PLIST" 2>/dev/null || true)

            if [ -z "$TEAM_ID" ] || [ -z "$PROFILE_NAME" ] || [ -z "$PROFILE_UUID" ] || [ -z "$APP_IDENTIFIER" ]; then
              echo "::error::Failed to extract required metadata from provisioning profile."
              cat "$PROFILE_PLIST"
              exit 1
            fi

            BUNDLE_ID="${APP_IDENTIFIER#*.}"

            SIGNING_IDENTITY=$(security find-identity -v -p codesigning "$WORK_KEYCHAIN_PATH" | sed -n 's/^.*"\(.*\)"$/\1/p' | head -n 1 || true)
            if [ -z "$SIGNING_IDENTITY" ]; then
              echo "::error::No signing identity found after importing certificate."
              security find-identity -v -p codesigning "$WORK_KEYCHAIN_PATH" || true
              exit 1
            fi

            SIGNING_CERT_TYPE=$(echo "$SIGNING_IDENTITY" | awk -F': ' '{print $1}' | xargs)

            {
              echo "team_id=$TEAM_ID"
              echo "profile_name=$PROFILE_NAME"
              echo "profile_uuid=$PROFILE_UUID"
              echo "bundle_id=$BUNDLE_ID"
              echo "profile_path=$PROFILE_PATH"
              echo "signing_identity=$SIGNING_IDENTITY"
              echo "signing_certificate_type=$SIGNING_CERT_TYPE"
              echo "keychain=$WORK_KEYCHAIN_PATH"
              echo "keychain_name=$WORK_KEYCHAIN"
            } >> "$GITHUB_OUTPUT"

            echo "‚úÖ Code signing configured"
          else
            echo "‚ö†Ô∏è No signing credentials provided, will build for simulator only"
          fi

      - name: üèóÔ∏è Build with Xcode (Native Turbo Modules)
        env:
          TEAM_ID: ${{ steps.setup_signing.outputs.team_id }}
          PROFILE_SPECIFIER: ${{ steps.setup_signing.outputs.profile_name }}
          PROFILE_UUID: ${{ steps.setup_signing.outputs.profile_uuid }}
          BUNDLE_ID: ${{ steps.setup_signing.outputs.bundle_id }}
          SIGNING_IDENTITY: ${{ steps.setup_signing.outputs.signing_identity }}
          SIGNING_CERTIFICATE_TYPE: ${{ steps.setup_signing.outputs.signing_certificate_type }}
          CUSTOM_KEYCHAIN: ${{ steps.setup_signing.outputs.keychain }}
        run: |
          set -euo pipefail

          echo "üöÄ Building iOS app with Native Turbo Modules..."
          cd ios

          # Find the workspace
          WORKSPACE=$(find . -name "*.xcworkspace" | head -n 1)
          echo "üìÅ Workspace: $WORKSPACE"

          # Use detected scheme
          SCHEME="${{ steps.detect_scheme.outputs.scheme }}"
          echo "üì± Scheme: $SCHEME"

          # Check if we have signing credentials
          if [ -n "$APPLE_CERTIFICATE" ]; then
            if [ -z "${TEAM_ID:-}" ] || [ -z "${PROFILE_SPECIFIER:-}" ] || [ -z "${PROFILE_UUID:-}" ] || [ -z "${BUNDLE_ID:-}" ] || [ -z "${SIGNING_IDENTITY:-}" ]; then
              echo "::error::Signing metadata missing even though certificate secret is set."
              exit 1
            fi

            echo "üîê Building with code signing for device"
            # Build archive for device (requires signing)
            DEFAULT_KEYCHAIN_PATH="$HOME/Library/Keychains/build.keychain-db"
            xcodebuild \
              -workspace "$WORKSPACE" \
              -scheme "$SCHEME" \
              -configuration "${{ inputs.configuration }}" \
              -sdk iphoneos \
              -destination generic/platform=iOS \
              -archivePath "./build/App.xcarchive" \
              DEVELOPMENT_TEAM="$TEAM_ID" \
              PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
              PROVISIONING_PROFILE_SPECIFIER="$PROFILE_SPECIFIER" \
              PROVISIONING_PROFILE="$PROFILE_UUID" \
              CODE_SIGN_STYLE=Manual \
              CODE_SIGN_IDENTITY="$SIGNING_IDENTITY" \
              OTHER_CODE_SIGN_FLAGS="--keychain ${CUSTOM_KEYCHAIN:-$DEFAULT_KEYCHAIN_PATH}" \
              archive \
              -allowProvisioningUpdates
            echo "‚úÖ Archive created successfully with native modules compiled"
          else
            echo "‚ö†Ô∏è Building without code signing (simulator only)"
            # Build for simulator (no archive, just build)
            xcodebuild \
              -workspace "$WORKSPACE" \
              -scheme "$SCHEME" \
              -configuration "${{ inputs.configuration }}" \
              -sdk iphonesimulator \
              -derivedDataPath "./build/DerivedData" \
              build
            echo "‚úÖ Simulator build completed successfully"
          fi

      - name: üì¶ Export Archive to IPA
        env:
          TEAM_ID: ${{ steps.setup_signing.outputs.team_id }}
          PROFILE_SPECIFIER: ${{ steps.setup_signing.outputs.profile_name }}
          BUNDLE_ID: ${{ steps.setup_signing.outputs.bundle_id }}
          SIGNING_CERTIFICATE_TYPE: ${{ steps.setup_signing.outputs.signing_certificate_type }}
        run: |
          if [ -n "$APPLE_CERTIFICATE" ]; then
            if [ -z "${TEAM_ID:-}" ] || [ -z "${PROFILE_SPECIFIER:-}" ] || [ -z "${BUNDLE_ID:-}" ] || [ -z "${SIGNING_CERTIFICATE_TYPE:-}" ]; then
              echo "::error::Missing signing metadata for export."
              exit 1
            fi

            echo "üì¶ Exporting archive to IPA..."
            cd ios

            # Create export options plist
            cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${TEAM_ID}</string>
              <key>signingCertificate</key>
              <string>${SIGNING_CERTIFICATE_TYPE}</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>${BUNDLE_ID}</key>
                  <string>${PROFILE_SPECIFIER}</string>
              </dict>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          EOF

            # Export the archive
            xcodebuild \
              -exportArchive \
              -archivePath "./build/App.xcarchive" \
              -exportPath "./build" \
              -exportOptionsPlist ExportOptions.plist \
              -allowProvisioningUpdates

            echo "‚úÖ IPA exported successfully"
          else
            echo "‚ö†Ô∏è Skipping IPA export (no signing credentials)"
          fi

      - name: üì¶ Create simulator build
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "üì¶ Creating simulator build package..."
            cd ios

            # Find the built .app in DerivedData
            APP_PATH=$(find build/DerivedData/Build/Products/*-iphonesimulator -name "*.app" -type d | head -n 1)

            if [ -z "$APP_PATH" ]; then
              echo "‚ùå Could not find built .app"
              echo "Searching in:"
              find build/DerivedData -name "*.app" -type d || echo "No .app found"
              exit 1
            fi

            echo "Found app at: $APP_PATH"

            # Create zip
            cd "$(dirname "$APP_PATH")"
            zip -r ../../../../App-Simulator.zip "$(basename "$APP_PATH")"

            echo "‚úÖ Simulator build created: App-Simulator.zip"
          else
            echo "‚ö†Ô∏è Skipping simulator build (signed IPA created instead)"
          fi

      - name: üìä Build artifacts info
        run: |
          echo "üìä Build artifacts:"
          ls -lh ios/build/ || echo "No build directory"
          if ls ios/build/*.ipa 1> /dev/null 2>&1; then
            IPA_SIZE=$(du -h ios/build/*.ipa | cut -f1)
            echo "üì¶ IPA Size: $IPA_SIZE"
          fi

      - name: üì§ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-native-modules-${{ inputs.configuration }}
          path: |
            ios/build/*.ipa
            ios/App-Simulator.zip
            ios/build/App.xcarchive
          if-no-files-found: warn
          retention-days: 30

      - name: üì± Submit to App Store
        if: ${{ inputs.submit_to_app_store }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID || secrets.EXPO_APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD || secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID || secrets.EXPO_APPSTORE_API_KEY_ID }}
          APPSTORE_API_ISSUER_ID: ${{ secrets.APPSTORE_API_ISSUER_ID || secrets.EXPO_APPSTORE_API_ISSUER_ID }}
          APPSTORE_API_PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY || secrets.EXPO_APPSTORE_API_PRIVATE_KEY }}
        run: |
          set -euo pipefail

          echo "üì± Submitting to App Store Connect..."
          cd ios

          IPA_FILE=$(find build -name "*.ipa" | head -n 1)

          if [ -z "$IPA_FILE" ]; then
            echo "‚ùå No IPA file found"
            exit 1
          fi

          echo "Found IPA: $IPA_FILE"

          if [ -n "${APPSTORE_API_KEY_ID:-}" ] && [ -n "${APPSTORE_API_ISSUER_ID:-}" ] && [ -n "${APPSTORE_API_PRIVATE_KEY:-}" ]; then
            echo "üîê Using App Store Connect API key (p8) for authentication."
            KEY_FILE=$(mktemp)
            trap 'rm -f "$KEY_FILE"' EXIT

            if echo "$APPSTORE_API_PRIVATE_KEY" | grep -q "BEGIN"; then
              printf '%b' "$APPSTORE_API_PRIVATE_KEY" > "$KEY_FILE"
            else
              if ! printf '%s' "$APPSTORE_API_PRIVATE_KEY" | base64 --decode > "$KEY_FILE" 2>/dev/null; then
                printf '%b' "$APPSTORE_API_PRIVATE_KEY" > "$KEY_FILE"
              fi
            fi

            xcrun altool --upload-app \
              --type ios \
              --file "$IPA_FILE" \
              --apiKey "$APPSTORE_API_KEY_ID" \
              --apiIssuer "$APPSTORE_API_ISSUER_ID" \
              --apiKeyFile "$KEY_FILE"
          elif [ -n "${APPLE_ID:-}" ] && [ -n "${APPLE_APP_SPECIFIC_PASSWORD:-}" ]; then
            echo "‚ö†Ô∏è App Store Connect API key missing; falling back to Apple ID credentials."
            xcrun altool --upload-app \
              --type ios \
              --file "$IPA_FILE" \
              --username "$APPLE_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD"
          else
            echo "::error::No App Store Connect credentials provided."
            exit 1
          fi

          echo "‚úÖ Submitted to App Store Connect"

      - name: ‚úÖ Build Summary
        if: always()
        run: |
          echo "================================================"
          echo "üéâ NATIVE MODULES BUILD COMPLETE"
          echo "================================================"
          echo ""
          echo "üñ•Ô∏è Built on: macOS-15 GitHub Runner"
          echo "üõ†Ô∏è Tool: Xcode (Native Turbo Modules)"
          echo "üîß Configuration: ${{ inputs.configuration }}"
          echo "üì± Scheme: ${{ steps.detect_scheme.outputs.scheme }}"
          echo ""
          echo "‚ú® Native iOS Turbo Modules Compiled:"
          echo "   - BatteryTurboModule"
          echo "   - BrightnessTurboModule"
          echo "   - SensorsTurboModule"
          echo "   - DeviceInfoTurboModule"
          echo "   - FlashlightTurboModule"
          echo ""
          echo "üì• Download the IPA from the Actions artifacts"
          echo "   Go to: Actions ‚Üí This workflow run ‚Üí Artifacts"
          echo ""
          if [ "${{ inputs.submit_to_app_store }}" == "true" ]; then
            echo "‚úÖ Submitted to App Store Connect"
            echo "   Check status at https://appstoreconnect.apple.com"
          fi
          echo "================================================"

      - name: üí¨ Create build summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## üéâ Native Turbo Modules Build Complete

          **Status:** ‚úÖ Build finished on macOS runner
          **Configuration:** ${{ inputs.configuration }}
          **Scheme:** ${{ steps.detect_scheme.outputs.scheme }}
          **Submitted to App Store:** ${{ inputs.submit_to_app_store == true && '‚úÖ Yes' || '‚ùå No' }}

          ### üèóÔ∏è Build Details
          - Built on: macOS-15 GitHub Runner
          - Xcode: $(xcodebuild -version | head -n 1)
          - Build system: Xcode (No EAS)
          - New Architecture: Enabled

          ### ‚ú® Native iOS Turbo Modules
          The following native modules were compiled:
          - **BatteryTurboModule** - Battery level and state monitoring
          - **BrightnessTurboModule** - Screen brightness control
          - **SensorsTurboModule** - Accelerometer, gyroscope, magnetometer
          - **DeviceInfoTurboModule** - Device model, OS, low power mode
          - **FlashlightTurboModule** - Flashlight/torch control

          ### üì• Download IPA
          The built IPA file is available as a workflow artifact. Download it from the "Artifacts" section above.

          ### üîó Useful Links
          - [Repository](https://github.com/\${{ github.repository }})
          - [Actions](\${{ github.server_url }}/\${{ github.repository }}/actions)
          $(if [ "${{ inputs.submit_to_app_store }}" == "true" ]; then
            echo "- [App Store Connect](https://appstoreconnect.apple.com)"
          fi)

          ---
          *Built with native iOS Turbo Modules on GitHub Actions macOS runner*
          EOF

      - name: üì§ Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-native-modules
          path: |
            **/*.log
            ios/build/
          if-no-files-found: warn
          retention-days: 7
