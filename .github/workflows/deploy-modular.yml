name: Deploy to iOS (Modular)

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: "Model to download and include"
        required: true
        default: "qwen2-0.5b"
        type: choice
        options:
          - qwen2-0.5b
          - llama-3.2-1b
          - smollm2-1.7b
          - phi-3-mini
          - all
      platform:
        description: "Build platform"
        required: true
        default: "eas-cloud"
        type: choice
        options:
          - eas-cloud
          - macos-local
      submit_to_app_store:
        description: "Submit to App Store after build"
        required: false
        type: boolean
        default: false

jobs:
  # Step 1: Download models
  download-models:
    name: Download ML Models
    uses: ./.github/workflows/download-models.yml
    permissions:
      contents: write
    with:
      model_name: ${{ inputs.model_name }}

  # Step 2: Build iOS app
  build-ios:
    name: Build iOS App
    needs: download-models
    runs-on: ${{ inputs.platform == 'macos-local' && 'macos-13' || 'ubuntu-latest' }}
    permissions:
      contents: read

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: main  # Pull latest with models
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ðŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ðŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ”§ Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ—ï¸ Build iOS
        run: |
          echo "ðŸš€ Building iOS app..."
          echo "Platform: ${{ inputs.platform }}"
          echo "Model: ${{ inputs.model_name }}"

          if [ "${{ inputs.platform }}" == "macos-local" ]; then
            eas build --platform ios --profile production --non-interactive --wait --local
          else
            eas build --platform ios --profile production --non-interactive --wait
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“‹ Get build info
        id: build_info
        run: |
          set +e

          echo "â³ Waiting for EAS to process build metadata..."
          sleep 10

          echo "ðŸ” Attempting to retrieve build information..."
          BUILD_LIST=$(eas build:list --platform ios --limit 1 --json --non-interactive 2>&1)
          EXIT_CODE=$?

          if [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ EAS build:list failed with exit code $EXIT_CODE"
            echo "ðŸ“‹ Error output: $BUILD_LIST"
            echo "build_id=unknown" >> $GITHUB_OUTPUT
            echo "build_url=unknown" >> $GITHUB_OUTPUT
          elif [ -z "$BUILD_LIST" ]; then
            echo "âš ï¸ No build list returned"
            echo "build_id=unknown" >> $GITHUB_OUTPUT
            echo "build_url=unknown" >> $GITHUB_OUTPUT
          elif ! echo "$BUILD_LIST" | jq -e '.' >/dev/null 2>&1; then
            echo "âš ï¸ Build list is not valid JSON"
            echo "ðŸ“‹ Output: $BUILD_LIST"
            echo "build_id=unknown" >> $GITHUB_OUTPUT
            echo "build_url=unknown" >> $GITHUB_OUTPUT
          else
            BUILD_ID=$(echo "$BUILD_LIST" | jq -r '.[0].id // empty')
            BUILD_URL=$(echo "$BUILD_LIST" | jq -r '.[0].artifacts.buildUrl // empty')

            if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" == "null" ]; then
              echo "âš ï¸ Could not extract build ID from response"
              echo "build_id=unknown" >> $GITHUB_OUTPUT
              echo "build_url=unknown" >> $GITHUB_OUTPUT
            else
              echo "build_id=${BUILD_ID}" >> $GITHUB_OUTPUT
              echo "build_url=${BUILD_URL}" >> $GITHUB_OUTPUT
              echo "âœ… Build ID: ${BUILD_ID}"
              echo "ðŸ”— Build URL: ${BUILD_URL}"
            fi
          fi

          set -e
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“¤ Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ inputs.platform }}
          path: |
            **/*.log
            .expo/
          if-no-files-found: warn
          retention-days: 7

    outputs:
      build_id: ${{ steps.build_info.outputs.build_id }}
      build_url: ${{ steps.build_info.outputs.build_url }}

  # Step 3: Submit to App Store (optional)
  submit-to-app-store:
    name: Submit to App Store
    needs: build-ios
    if: ${{ inputs.submit_to_app_store }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“± Submit to App Store
        run: |
          echo "ðŸ“± Submitting build ${{ needs.build-ios.outputs.build_id }} to App Store..."
          eas submit --platform ios --id ${{ needs.build-ios.outputs.build_id }} --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_APPLE_ID: ${{ secrets.APPLE_ID }}
          EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

  # Step 4: Summary
  summary:
    name: Deployment Summary
    needs: [download-models, build-ios, submit-to-app-store]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“Š Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸŽ‰ iOS Deployment Complete

          **Model:** ${{ inputs.model_name }}
          **Platform:** ${{ inputs.platform }}
          **Build ID:** ${{ needs.build-ios.outputs.build_id }}
          **App Store Submission:** ${{ inputs.submit_to_app_store && 'âœ… Submitted' || 'â­ï¸ Skipped' }}

          ### ðŸ”— Links
          - [View Build](${{ needs.build-ios.outputs.build_url }})
          - [EAS Dashboard](https://expo.dev)
          - [App Store Connect](https://appstoreconnect.apple.com)

          ### ðŸ“ Manual Submission
          If you want to submit manually:
          \`\`\`bash
          eas submit --platform ios --id ${{ needs.build-ios.outputs.build_id }}
          \`\`\`
          EOF
