name: Full Automated iOS Deployment (macOS Native)

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Model to download and include'
        required: true
        default: 'qwen2-0.5b'
        type: choice
        options:
          - qwen2-0.5b
          - llama-3.2-1b
          - smollm2-1.7b
          - phi-3-mini
          - all
      submit_to_app_store:
        description: 'Submit to App Store after build'
        required: false
        type: boolean
        default: false

env:
  MODELS_DIR: ./assets/models

jobs:
  build-and-deploy-macos:
    name: Build & Deploy on macOS Runner
    runs-on: macos-14  # Latest macOS with Apple Silicon (M1)
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: ğŸ—‚ï¸ Setup Git LFS
        run: |
          git lfs install
          git lfs track "*.gguf"
          git add .gitattributes
          echo "âœ… Git LFS configured"

      - name: ğŸ System Information
        run: |
          echo "ğŸ–¥ï¸ macOS Version:"
          sw_vers
          echo ""
          echo "ğŸ’» Hardware:"
          sysctl hw.model hw.machine hw.ncpu hw.memsize
          echo ""
          echo "ğŸ› ï¸ Xcode Version:"
          xcodebuild -version
          echo ""
          echo "ğŸ“± Available iOS SDKs:"
          xcodebuild -showsdks

      - name: ğŸ Setup Python for model downloads
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Python dependencies
        run: |
          pip3 install huggingface-hub requests tqdm

      - name: ğŸ“ Create models directory
        run: |
          mkdir -p ${{ env.MODELS_DIR }}

      - name: â¬‡ï¸ Download Qwen2 0.5B Instruct
        if: ${{ inputs.model_name == 'qwen2-0.5b' || inputs.model_name == 'all' }}
        run: |
          python3 - <<'EOF'
          from huggingface_hub import hf_hub_download
          import os
          print("ğŸ“¥ Downloading Qwen2 0.5B Instruct Q4_K_M...")
          file_path = hf_hub_download(
              repo_id="Qwen/Qwen2-0.5B-Instruct-GGUF",
              filename="qwen2-0_5b-instruct-q4_k_m.gguf",
              local_dir="${{ env.MODELS_DIR }}",
              local_dir_use_symlinks=False
          )
          print(f"âœ… Downloaded to: {file_path}")
          print(f"ğŸ“Š Size: {os.path.getsize(file_path) / (1024*1024):.2f} MB")
          EOF

      - name: â¬‡ï¸ Download Llama 3.2 1B Instruct
        if: ${{ inputs.model_name == 'llama-3.2-1b' || inputs.model_name == 'all' }}
        run: |
          python3 - <<'EOF'
          from huggingface_hub import hf_hub_download
          import os
          print("ğŸ“¥ Downloading Llama 3.2 1B Instruct Q4_K_M...")
          file_path = hf_hub_download(
              repo_id="ggml-org/Llama-3.2-1B-Instruct-GGUF",
              filename="Llama-3.2-1B-Instruct-Q4_K_M.gguf",
              local_dir="${{ env.MODELS_DIR }}",
              local_dir_use_symlinks=False
          )
          print(f"âœ… Downloaded to: {file_path}")
          print(f"ğŸ“Š Size: {os.path.getsize(file_path) / (1024*1024):.2f} MB")
          EOF

      - name: â¬‡ï¸ Download SmolLM2 1.7B Instruct
        if: ${{ inputs.model_name == 'smollm2-1.7b' || inputs.model_name == 'all' }}
        run: |
          python3 - <<'EOF'
          from huggingface_hub import hf_hub_download
          import os
          print("ğŸ“¥ Downloading SmolLM2 1.7B Instruct Q4_K_M...")
          file_path = hf_hub_download(
              repo_id="HuggingFaceTB/SmolLM2-1.7B-Instruct-GGUF",
              filename="smollm2-1.7b-instruct-q4_k_m.gguf",
              local_dir="${{ env.MODELS_DIR }}",
              local_dir_use_symlinks=False
          )
          print(f"âœ… Downloaded to: {file_path}")
          print(f"ğŸ“Š Size: {os.path.getsize(file_path) / (1024*1024):.2f} MB")
          EOF

      - name: â¬‡ï¸ Download Phi-3 Mini 3.8B
        if: ${{ inputs.model_name == 'phi-3-mini' || inputs.model_name == 'all' }}
        run: |
          python3 - <<'EOF'
          from huggingface_hub import hf_hub_download
          import os
          print("ğŸ“¥ Downloading Phi-3 Mini 4K Instruct Q4...")
          file_path = hf_hub_download(
              repo_id="microsoft/Phi-3-mini-4k-instruct-gguf",
              filename="Phi-3-mini-4k-instruct-q4.gguf",
              local_dir="${{ env.MODELS_DIR }}",
              local_dir_use_symlinks=False
          )
          print(f"âœ… Downloaded to: {file_path}")
          print(f"ğŸ“Š Size: {os.path.getsize(file_path) / (1024*1024):.2f} MB")
          EOF

      - name: ğŸ“Š Verify downloaded models
        run: |
          echo "ğŸ“ Downloaded models:"
          ls -lh ${{ env.MODELS_DIR }}
          echo ""
          echo "ğŸ’¾ Total size:"
          du -sh ${{ env.MODELS_DIR }}

      - name: ğŸ’¾ Commit models to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Ensure LFS tracking
          git lfs track "*.gguf"
          git add .gitattributes

          git add ${{ env.MODELS_DIR }}
          git add -A
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "Add ML models for macOS native build - Model: ${{ inputs.model_name }}, Build type: macOS native GitHub Actions [LFS]"
            git lfs push --all origin main
            git push
            echo "âœ… Models committed and pushed with LFS"
          fi

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Install JavaScript dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies with bun..."
          bun install --frozen-lockfile
          echo "âœ… Dependencies installed"

      - name: ğŸ”§ Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ—ï¸ Build iOS with EAS (on macOS)
        run: |
          echo "ğŸš€ Starting EAS Build for iOS..."
          echo "Running on macOS GitHub Runner"
          echo "Model: ${{ inputs.model_name }}"
          echo ""

          # Build with EAS (which will use our macOS environment)
          eas build \
            --platform ios \
            --profile production \
            --non-interactive \
            --wait \
            --local
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“‹ Get build information
        id: build_info
        run: |
          BUILD_ID=$(eas build:list --platform ios --limit 1 --json | jq -r '.[0].id // empty')
          BUILD_URL=$(eas build:list --platform ios --limit 1 --json | jq -r '.[0].artifacts.buildUrl // empty')

          echo "build_id=${BUILD_ID}" >> $GITHUB_OUTPUT
          echo "build_url=${BUILD_URL}" >> $GITHUB_OUTPUT

          echo "ğŸ†” Build ID: ${BUILD_ID}"
          echo "ğŸ”— Build URL: ${BUILD_URL}"

      - name: ğŸ“± Submit to App Store
        if: ${{ inputs.submit_to_app_store }}
        run: |
          echo "ğŸ“± Submitting to App Store Connect..."

          eas submit \
            --platform ios \
            --latest \
            --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_APPLE_ID: ${{ secrets.APPLE_ID }}
          EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

      - name: âœ… Deployment Summary
        if: always()
        run: |
          echo "================================================"
          echo "ğŸ‰ MACOS NATIVE BUILD COMPLETE"
          echo "================================================"
          echo ""
          echo "ğŸ–¥ï¸ Built on: macOS GitHub Runner"
          echo "ğŸ“¦ Model: ${{ inputs.model_name }}"
          echo "ğŸ†” Build ID: ${{ steps.build_info.outputs.build_id }}"
          echo "ğŸ”— Build URL: ${{ steps.build_info.outputs.build_url }}"
          echo ""
          if [ "${{ inputs.submit_to_app_store }}" == "true" ]; then
            echo "âœ… Submitted to App Store Connect"
            echo ""
            echo "ğŸ“± Next: Check App Store Connect for review status"
            echo "   https://appstoreconnect.apple.com"
          else
            echo "â­ï¸ Not submitted to App Store (submit_to_app_store=false)"
            echo ""
            echo "To submit manually from Vibecode:"
            echo "   eas submit --platform ios --id ${{ steps.build_info.outputs.build_id }}"
          fi
          echo ""
          echo "================================================"

      - name: ğŸ’¬ Create deployment summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ğŸ‰ macOS Native Build Complete

          **Status:** âœ… Build finished on macOS runner
          **Model:** ${{ inputs.model_name }}
          **Build ID:** ${{ steps.build_info.outputs.build_id }}
          **Submitted to App Store:** ${{ inputs.submit_to_app_store == 'true' && 'âœ… Yes' || 'âŒ No' }}

          ### ğŸ—ï¸ Build Details
          - Built on: macOS-14 GitHub Runner
          - Xcode: Latest
          - Native compilation: All native modules compiled on macOS

          $(if [ "${{ inputs.submit_to_app_store }}" == "true" ]; then
            echo "### âœ… Submitted to App Store"
            echo "Check status at [App Store Connect](https://appstoreconnect.apple.com)"
          else
            echo "### ğŸ“± Submit to App Store"
            echo "\`\`\`bash"
            echo "eas submit --platform ios --id ${{ steps.build_info.outputs.build_id }}"
            echo "\`\`\`"
          fi)

          ### ğŸ”— Links
          - [View Build Details](${{ steps.build_info.outputs.build_url }})
          - [EAS Dashboard](https://expo.dev)
          - [App Store Connect](https://appstoreconnect.apple.com)

          ---
          *Full automated deployment on macOS runner*
          EOF

      - name: ğŸ“¤ Upload build artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-macos
          path: |
            **/*.log
            .expo/
          if-no-files-found: warn
          retention-days: 7
