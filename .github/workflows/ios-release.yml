name: iOS Release (TestFlight)

on:
  workflow_dispatch:
    inputs:
      build_configuration:
        description: "Xcode configuration"
        required: true
        default: "Release"
      scheme:
        description: "Override Xcode scheme (optional)"
        required: false
        default: ""

permissions:
  contents: read

env:
  # === App details (update as needed) ===
  APP_NAME: monGARS
  BUNDLE_ID: com.vibecode.offllmappstorefixer-iz6sup
  EXPORT_METHOD: app-store
  TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

jobs:
  preflight:
    name: Preflight (secrets & environment)
    runs-on: macos-14
    steps:
      - name: Check core secrets
        shell: bash
        run: |
          set -euo pipefail
          missing=0

          req_secrets=("IOS_P12_BASE64" "IOS_P12_PASSWORD" "IOS_PROVISIONING_PROFILE_BASE64" \
                       "APPLE_TEAM_ID" "APPSTORE_API_KEY_ID" "APPSTORE_API_ISSUER_ID" "APPSTORE_API_PRIVATE_KEY")
          for key in "${req_secrets[@]}"; do
            if [ -z "${!key:-}" ]; then
              echo "::error title=Missing secret::$key is not set in repository secrets."
              missing=1
            else
              echo "✔ $key present"
            fi
          done
          if [ "$missing" -ne 0 ]; then
            echo "::error::One or more required secrets are missing. Add them and re-run."
            exit 1
          fi
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APPSTORE_API_ISSUER_ID: ${{ secrets.APPSTORE_API_ISSUER_ID }}
          APPSTORE_API_PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

  build-and-upload:
    name: Build & Upload to TestFlight
    runs-on: macos-14
    timeout-minutes: 70
    needs: preflight

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode (15.4)
        run: sudo xcode-select -s "/Applications/Xcode_15.4.app/Contents/Developer"

      - name: Show Xcode version
        run: xcodebuild -version

      # ---------- JS deps: safe & optional ----------
      - name: Setup Node (for RN/Expo projects)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install JS deps (only if needed)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f package.json ]; then
            echo "No package.json at repo root — skipping JS deps."
            exit 0
          fi
          echo "Detected package.json, choosing package manager…"
          if [ -f pnpm-lock.yaml ]; then
            echo "Using pnpm with frozen lockfile"
            corepack enable
            pnpm i --frozen-lockfile
          elif [ -f yarn.lock ]; then
            echo "Using yarn with frozen lockfile"
            corepack enable
            yarn install --frozen-lockfile
          elif [ -f package-lock.json ]; then
            echo "Using npm ci (lockfile present)"
            npm ci
          else
            echo "No lockfile found — falling back to npm install (non-frozen)"
            npm install --no-audit --fund=false
          fi

      - name: Bump iOS version and build number
        run: node scripts/bump-ios-version.js --type ${{ github.event.inputs.bump_type || 'patch' }}

      # ---------- CocoaPods: only if Podfile exists ----------
      - name: Install CocoaPods (if Podfile exists)
        shell: bash
        run: |
          set -e
          if [ -f ios/Podfile ]; then
            gem install cocoapods --no-document
            cd ios && pod install --repo-update
          else
            echo "No ios/Podfile — skipping pod install."
          fi

      # ---------- Import signing assets ----------
      - name: Import signing certificate (.p12)
        id: import_certs
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_P12_BASE64 }}
          p12-password: ${{ secrets.IOS_P12_PASSWORD }}

      - name: Install provisioning profile
        id: install_profile
        shell: bash
        env:
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          set -euo pipefail
          DEST_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$DEST_DIR"
          PROFILE_PATH="$DEST_DIR/appstore.mobileprovision"
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > "$PROFILE_PATH"
          echo "profile_path=$PROFILE_PATH" >> "$GITHUB_OUTPUT"
          ls -la "$DEST_DIR"

      - name: Extract provisioning profile metadata
        id: profile_metadata
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ steps.install_profile.outputs.profile_path }}" ]; then
            echo "::error::Provisioning profile path missing from previous step."
            exit 1
          fi

          PROFILE_PLIST=$(mktemp)
          security cms -D -i "${{ steps.install_profile.outputs.profile_path }}" > "$PROFILE_PLIST"

          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$PROFILE_PLIST")
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' "$PROFILE_PLIST")
          APP_IDENTIFIER=$(/usr/libexec/PlistBuddy -c 'Print :Entitlements:application-identifier' "$PROFILE_PLIST")

          if [ -z "$APP_IDENTIFIER" ]; then
            echo "::error::Could not read application-identifier from provisioning profile."
            cat "$PROFILE_PLIST"
            exit 1
          fi

          BUNDLE_ID="${APP_IDENTIFIER#*.}"

          echo "uuid=$PROFILE_UUID" >> "$GITHUB_OUTPUT"
          echo "specifier=$PROFILE_NAME" >> "$GITHUB_OUTPUT"
          echo "bundle_id=$BUNDLE_ID" >> "$GITHUB_OUTPUT"

          echo "Detected provisioning profile:" "UUID=$PROFILE_UUID" "Name=$PROFILE_NAME" "BundleID=$BUNDLE_ID"

          echo "BUNDLE_ID=$BUNDLE_ID" >> "$GITHUB_ENV"

      - name: Detect signing identity
        id: signing_identity
        shell: bash
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="${{ steps.import_certs.outputs.keychain-path }}"
          STATUS=0
          if [ -n "$KEYCHAIN_PATH" ]; then
            echo "Inspecting codesigning identities in $KEYCHAIN_PATH"
            set +e
            IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | sed -n 's/^.*"\(.*\)"$/\1/p' | head -n 1)
            STATUS=$?
            set -euo pipefail
          else
            echo "No keychain path reported by import step; checking default keychains"
            set +e
            IDENTITY=$(security find-identity -v -p codesigning | sed -n 's/^.*"\(.*\)"$/\1/p' | head -n 1)
            STATUS=$?
            set -euo pipefail
          fi
          if [ "$STATUS" -ne 0 ]; then
            IDENTITY=""
          fi
          if [ -z "$IDENTITY" ]; then
            echo "::warning::No signing identity found after importing certificates."
            if [ -n "$KEYCHAIN_PATH" ]; then
              security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true
            else
              security find-identity -v -p codesigning || true
            fi
            echo "identity=" >> "$GITHUB_OUTPUT"
            echo "style=automatic" >> "$GITHUB_OUTPUT"
          else
            echo "identity=$IDENTITY" >> "$GITHUB_OUTPUT"
            echo "style=manual" >> "$GITHUB_OUTPUT"
            echo "Using signing identity: $IDENTITY"
          fi

      # ---------- Discover workspace/project automatically ----------
      - name: Discover Xcode workspace/project
        id: discover
        shell: bash
        run: |
          set -euo pipefail
          ROOT="."
          if [ -d "ios" ]; then ROOT="ios"; fi
          WORKSPACE=$(find "$ROOT" -maxdepth 2 -name "*.xcworkspace" | head -n 1 || true)
          PROJECT=$(find "$ROOT" -maxdepth 2 -name "*.xcodeproj" | head -n 1 || true)
          if [ -n "$WORKSPACE" ]; then
            echo "kind=workspace" >> $GITHUB_OUTPUT
            echo "path=$WORKSPACE" >> $GITHUB_OUTPUT
          elif [ -n "$PROJECT" ]; then
            echo "kind=project" >> $GITHUB_OUTPUT
            echo "path=$PROJECT" >> $GITHUB_OUTPUT
          else
            echo "::error::Could not find any .xcworkspace or .xcodeproj under $ROOT"
            exit 1
          fi
          echo "Discovered: kind=$(cat $GITHUB_OUTPUT | sed -n 's/^kind=//p'), path=$(cat $GITHUB_OUTPUT | sed -n 's/^path=//p')"

      - name: Detect Xcode scheme
        id: detect_scheme
        shell: bash
        env:
          SCHEME_OVERRIDE: ${{ github.event.inputs.scheme }}
        run: |
          set -euo pipefail
          if [ -n "${SCHEME_OVERRIDE:-}" ]; then
            echo "Using scheme override from workflow dispatch input: ${SCHEME_OVERRIDE}"
            SCHEME="$SCHEME_OVERRIDE"
          else
            TARGET_PATH="${{ steps.discover.outputs.path }}"
            TARGET_KIND="${{ steps.discover.outputs.kind }}"
            if [ -z "$TARGET_PATH" ] || [ -z "$TARGET_KIND" ]; then
              echo "::error::Unable to detect project/workspace path from previous step."
              exit 1
            fi

            TARGET_DIR=$(dirname "$TARGET_PATH")
            BASENAME=$(basename "$TARGET_PATH")
            cd "$TARGET_DIR"

            if [ "$TARGET_KIND" = "workspace" ]; then
              CONTAINER_FLAG="-workspace"
              CONTAINER_NAME="${BASENAME%.xcworkspace}"
            else
              CONTAINER_FLAG="-project"
              CONTAINER_NAME="${BASENAME%.xcodeproj}"
            fi

            echo "Inspecting ${TARGET_KIND} $BASENAME for schemes"
            REPO_ROOT="${GITHUB_WORKSPACE:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"
            SCHEME=$(xcodebuild -list -json "$CONTAINER_FLAG" "$BASENAME" | \
              python3 "$REPO_ROOT/.github/scripts/detect_scheme.py" --candidate "$CONTAINER_NAME")
            if [ -z "$SCHEME" ]; then
              echo "::error::Failed to auto-detect an app scheme. Provide one via the workflow input."
              exit 1
            fi
            echo "Auto-detected scheme: $SCHEME"
          fi

          echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"

      - name: Create exportOptions.plist
        env:
          SIGNING_STYLE: ${{ steps.signing_identity.outputs.style }}
          PROFILE_SPECIFIER: ${{ steps.profile_metadata.outputs.specifier }}
          TEAM_ID: ${{ env.TEAM_ID }}
          BUNDLE_ID: ${{ env.BUNDLE_ID }}
        run: |
          set -euo pipefail
          STYLE="${SIGNING_STYLE:-manual}"
          STYLE_LOWER=$(printf '%s' "$STYLE" | tr '[:upper:]' '[:lower:]')

          cat > exportOptions.plist <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>manageAppVersionAndBuildNumber</key><false/>
            <key>signingStyle</key><string>${STYLE_LOWER}</string>
            <key>stripSwiftSymbols</key><true/>
            <key>thinning</key><string>&lt;none&gt;</string>
            <key>destination</key><string>export</string>
            <key>teamID</key><string>${TEAM_ID}</string>
          </dict>
          </plist>
          PLIST

          if [ "$STYLE_LOWER" = "manual" ]; then
            if [ -z "${PROFILE_SPECIFIER:-}" ] || [ -z "${BUNDLE_ID:-}" ]; then
              echo "::error::Provisioning profile information missing for manual signing."
              exit 1
            fi
            /usr/libexec/PlistBuddy -c "Add :provisioningProfiles dict" exportOptions.plist
            /usr/libexec/PlistBuddy -c "Add :provisioningProfiles:${BUNDLE_ID} string ${PROFILE_SPECIFIER}" exportOptions.plist
          fi

      - name: Xcode archive
        shell: bash
        env:
          SIGNING_STYLE: ${{ steps.signing_identity.outputs.style }}
          SIGNING_IDENTITY: ${{ steps.signing_identity.outputs.identity }}
          PROFILE_SPECIFIER: ${{ steps.profile_metadata.outputs.specifier }}
          PROFILE_UUID: ${{ steps.profile_metadata.outputs.uuid }}
          BUNDLE_ID: ${{ env.BUNDLE_ID }}
        run: |
          set -euo pipefail
          ARCHIVE_PATH="$PWD/build/${{ env.APP_NAME }}.xcarchive"
          STYLE="${SIGNING_STYLE:-manual}"
          STYLE_LOWER=$(printf '%s' "$STYLE" | tr '[:upper:]' '[:lower:]')

          if [ "$STYLE_LOWER" = "manual" ]; then
            if [ -z "${PROFILE_UUID:-}" ] || [ -z "${PROFILE_SPECIFIER:-}" ]; then
              echo "::error::Provisioning profile metadata missing — cannot continue with manual codesigning."
              exit 1
            fi
            if [ -z "${SIGNING_IDENTITY:-}" ]; then
              echo "::error::Signing identity missing — cannot continue with manual codesigning."
              exit 1
            fi
          fi

          if [ "${{ steps.discover.outputs.kind }}" = "workspace" ]; then
            CONTAINER_FLAG="-workspace"
          else
            CONTAINER_FLAG="-project"
          fi

          declare -a CMD=(
            "xcodebuild"
            "$CONTAINER_FLAG" "${{ steps.discover.outputs.path }}"
            "-scheme" "${{ steps.detect_scheme.outputs.scheme }}"
            "-configuration" "${{ github.event.inputs.build_configuration }}"
            "-archivePath" "$ARCHIVE_PATH"
            "clean" "archive"
            "DEVELOPMENT_TEAM=${{ env.TEAM_ID }}"
            "ONLY_ACTIVE_ARCH=NO"
            "-allowProvisioningUpdates"
            "-showBuildTimingSummary"
          )

          if [ "$STYLE_LOWER" = "manual" ]; then
            CMD+=(
              "CODE_SIGN_STYLE=Manual"
              "CODE_SIGN_IDENTITY=${SIGNING_IDENTITY}"
              "PROVISIONING_PROFILE_SPECIFIER=${PROFILE_SPECIFIER}"
              "PROVISIONING_PROFILE=${PROFILE_UUID}"
            )
            if [ -n "${BUNDLE_ID:-}" ]; then
              CMD+=("PRODUCT_BUNDLE_IDENTIFIER=${BUNDLE_ID}")
            fi
          else
            CMD+=("CODE_SIGN_STYLE=Automatic")
            if [ -n "${BUNDLE_ID:-}" ]; then
              CMD+=("PRODUCT_BUNDLE_IDENTIFIER=${BUNDLE_ID}")
            fi
          fi

          echo "Running: ${CMD[*]}"
          "${CMD[@]}"

      - name: Export IPA
        shell: bash
        run: |
          set -e
          ARCHIVE_PATH="$PWD/build/${{ env.APP_NAME }}.xcarchive"
          EXPORT_PATH="$PWD/build/export"
          mkdir -p "$EXPORT_PATH"
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath "$EXPORT_PATH" \
            -allowProvisioningUpdates
          echo "Exported files:"
          ls -la "$EXPORT_PATH"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ env.APP_NAME }}-${{ github.run_number }}
          path: |
            build/${{ env.APP_NAME }}.xcarchive
            build/export/*.ipa
            build/export/*.dSYM.zip
            build/export/*.plist
          if-no-files-found: warn
          retention-days: 14

      # ---------- App Store Connect upload ----------
      - name: Write ASC API private key
        shell: bash
        env:
          APPSTORE_API_PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.private_keys"
          echo "$APPSTORE_API_PRIVATE_KEY" > "$HOME/.private_keys/${APPSTORE_API_KEY_ID}.p8"
          chmod 600 "$HOME/.private_keys/${APPSTORE_API_KEY_ID}.p8"
          echo "Saved key to $HOME/.private_keys/${APPSTORE_API_KEY_ID}.p8"

      - name: Upload to TestFlight (iTMSTransporter)
        shell: bash
        env:
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APPSTORE_API_ISSUER_ID: ${{ secrets.APPSTORE_API_ISSUER_ID }}
        run: |
          set -e
          IPA_PATH="$(ls build/export/*.ipa | head -n 1 || true)"
          if [ -z "$IPA_PATH" ]; then
            echo "::error::No IPA produced. Check build/export/ contents."
            ls -la build/export/ || true
            exit 1
          fi
          xcrun iTMSTransporter -m upload \
            -assetFile "$IPA_PATH" \
            -apiKey "${APPSTORE_API_KEY_ID}" \
            -apiIssuer "${APPSTORE_API_ISSUER_ID}" \
            -v informational
