name: iOS ‚Äî Generate Native Files & Commit

# This workflow generates iOS native files (Pods, codegen) and commits them for VibeCode.
#
# SETUP REQUIRED:
# To create pull requests, you need to either:
# 1. Add a Personal Access Token (PAT) as a secret named GH_PAT with repo permissions, OR
# 2. Go to Settings > Actions > General > Workflow permissions and enable
#    "Allow GitHub Actions to create and approve pull requests"
#
# Without this setup, you can still use "direct_push" mode to commit directly to your branch.

on:
  workflow_dispatch:
    inputs:
      push_mode:
        description: "How to publish changes"
        required: true
        default: "pull_request"
        type: choice
        options:
          - pull_request   # open a PR with the generated files (safe default)
          - direct_push    # push directly to the source branch
      build_configuration:
        description: "Xcode configuration (for a quick compile to trigger codegen)"
        required: true
        default: "Release"
        type: choice
        options: [Debug, Release]

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-and-commit:
    runs-on: macos-14
    env:
      # Expo/RN deterministic environment
      CI: "true"
      EXPO_NO_TELEMETRY: "1"
      EXPO_DO_NOT_TRACK: "1"
      EAS_NO_VCS: "1"
      RCT_NEW_ARCH_ENABLED: "1"

      # workflow inputs
      PUSH_MODE: ${{ github.event.inputs.push_mode }}
      BUILD_CONFIGURATION: ${{ github.event.inputs.build_configuration }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üß∞ Toolchain (Node, Ruby/CocoaPods, Watchman)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: üîß Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: ‚åö Install watchman
        run: brew install watchman
      - name: üíé Install CocoaPods
        run: sudo gem install cocoapods -v "1.15.2"
      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: üì¶ Install JS deps
        run: bun install --frozen-lockfile

      - name: üèóÔ∏è Expo prebuild (iOS)
        shell: bash
        run: |
          # Generate ios/ project from Expo config if missing or if you want to refresh
          npx expo prebuild --platform ios --no-install --clean || npx expo prebuild --platform ios --no-install
          # Ensure Podfile exists
          test -f ios/Podfile || { echo "::error::Podfile not found after prebuild"; exit 1; }

      - name: üî© React Native codegen (new architecture)
        shell: bash
        run: |
          # Ensures all JS specs -> ObjC/Swift sources are emitted before pod install
          # RN 0.73+: codegen is internally run by pods; we pre-run to be explicit
          npx react-native codegen || true

      - name: üìö CocoaPods install (with new arch flags)
        working-directory: ios
        shell: bash
        env:
          RCT_NEW_ARCH_ENABLED: "1"
        run: |
          pod repo update
          RCT_NEW_ARCH_ENABLED=1 pod install --verbose

      - name: üî® Quick compile to materialise generated sources
        id: xcodebuild
        shell: bash
        run: |
          set -euo pipefail
          SCHEME_DETECT=$(xcodebuild -workspace ios/*.xcworkspace -list -json | python3 -c '
          import json,sys
          j=json.load(sys.stdin)
          d=j.get("workspace") or j.get("project") or {}
          s=d.get("schemes") or []
          print(s[0] if s else "")
          ')
          if [ -z "$SCHEME_DETECT" ]; then
            echo "::error::Could not detect an iOS scheme. Set one in Xcode or add IOS_SCHEME env."
            exit 1
          fi
          echo "Detected scheme: $SCHEME_DETECT"
          xcodebuild \
            -workspace ios/*.xcworkspace \
            -scheme "$SCHEME_DETECT" \
            -configuration "${BUILD_CONFIGURATION}" \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath ios/DerivedData \
            build | xcpretty

          echo "scheme=$SCHEME_DETECT" >> "$GITHUB_OUTPUT"

      - name: üìã List generated files (keeping all artifacts)
        shell: bash
        run: |
          echo "‚úÖ Keeping all generated files including binaries"
          echo "üìÅ Generated sources:"
          find ios -type d -name "GeneratedSources" -maxdepth 3 -print || true
          find ios -type d -name "generated" -maxdepth 3 -print || true
          echo "üì¶ Pods directory size:"
          du -sh ios/Pods 2>/dev/null || echo "Pods not found"
          echo "üî® Build artifacts:"
          du -sh ios/DerivedData 2>/dev/null || echo "DerivedData not found"
          du -sh ios/build 2>/dev/null || echo "build not found"

      - name: üóÇÔ∏è Normalise line endings & file modes
        run: |
          git config core.autocrlf false
          git config core.filemode false

      - name: üìù Commit generated iOS sources (Pods + codegen + prebuild)
        if: ${{ env.PUSH_MODE == 'direct_push' }}
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${GITHUB_REF_NAME}"
          git add ios
          # If you also want to commit android/ prebuild outputs, uncomment:
          # npx expo prebuild --platform android --no-install || true
          # git add android

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "chore(ios): commit generated native files (Pods, codegen, prebuild) ‚Äî ${BUILD_CONFIGURATION}"

          # Push using HEAD reference which works better in Actions
          git push origin HEAD:refs/heads/${BRANCH}

      - name: üîÄ Create PR with generated iOS sources
        if: ${{ env.PUSH_MODE == 'pull_request' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          commit-message: "chore(ios): commit generated native files (Pods, codegen, prebuild) ‚Äî ${{ env.BUILD_CONFIGURATION }}"
          branch: chore/ios-generated-${{ github.run_id }}
          title: "iOS: add generated native files (Pods + codegen)"
          body: |
            This PR adds/refreshes all **generated native iOS** inputs required to run the app without rebuilding native code (useful for VibeCode).
            - Expo `prebuild` outputs in `ios/`
            - CocoaPods (`ios/Pods/**`, `Podfile.lock`)
            - RN new architecture codegen results
            - Excludes heavy build artefacts (DerivedData products)

            ‚úÖ After merge, VibeCode can pull the repo and run with complete native sources.

          labels: |
            ios
            automation
          add-paths: |
            ios/**
