name: Build & Prepare for Vibecode Deployment

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Model to download and include'
        required: true
        default: 'qwen2-0.5b'
        type: choice
        options:
          - qwen2-0.5b
          - llama-3.2-1b
          - smollm2-1.7b
          - phi-3-mini
          - all
      profile:
        description: 'EAS Build profile'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

env:
  MODELS_DIR: ./assets/models

jobs:
  build-everything:
    name: Download Models & Build iOS App
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Setup Python for model downloads
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Install Python dependencies
        run: |
          pip install huggingface-hub requests tqdm

      - name: üìÅ Create models directory
        run: |
          mkdir -p ${{ env.MODELS_DIR }}

      - name: ‚¨áÔ∏è Download Qwen2 0.5B Instruct
        if: ${{ inputs.model_name == 'qwen2-0.5b' || inputs.model_name == 'all' }}
        run: |
          python - <<'EOF'
          from huggingface_hub import hf_hub_download
          import os
          print("üì• Downloading Qwen2 0.5B Instruct Q4_K_M...")
          file_path = hf_hub_download(
              repo_id="Qwen/Qwen2-0.5B-Instruct-GGUF",
              filename="qwen2-0_5b-instruct-q4_k_m.gguf",
              local_dir="${{ env.MODELS_DIR }}",
              local_dir_use_symlinks=False
          )
          print(f"‚úÖ Downloaded to: {file_path}")
          print(f"üìä Size: {os.path.getsize(file_path) / (1024*1024):.2f} MB")
          EOF

      - name: ‚¨áÔ∏è Download Llama 3.2 1B Instruct
        if: ${{ inputs.model_name == 'llama-3.2-1b' || inputs.model_name == 'all' }}
        run: |
          python - <<'EOF'
          from huggingface_hub import hf_hub_download
          import os
          print("üì• Downloading Llama 3.2 1B Instruct Q4_K_M...")
          file_path = hf_hub_download(
              repo_id="ggml-org/Llama-3.2-1B-Instruct-GGUF",
              filename="Llama-3.2-1B-Instruct-Q4_K_M.gguf",
              local_dir="${{ env.MODELS_DIR }}",
              local_dir_use_symlinks=False
          )
          print(f"‚úÖ Downloaded to: {file_path}")
          print(f"üìä Size: {os.path.getsize(file_path) / (1024*1024):.2f} MB")
          EOF

      - name: ‚¨áÔ∏è Download SmolLM2 1.7B Instruct
        if: ${{ inputs.model_name == 'smollm2-1.7b' || inputs.model_name == 'all' }}
        run: |
          python - <<'EOF'
          from huggingface_hub import hf_hub_download
          import os
          print("üì• Downloading SmolLM2 1.7B Instruct Q4_K_M...")
          file_path = hf_hub_download(
              repo_id="HuggingFaceTB/SmolLM2-1.7B-Instruct-GGUF",
              filename="smollm2-1.7b-instruct-q4_k_m.gguf",
              local_dir="${{ env.MODELS_DIR }}",
              local_dir_use_symlinks=False
          )
          print(f"‚úÖ Downloaded to: {file_path}")
          print(f"üìä Size: {os.path.getsize(file_path) / (1024*1024):.2f} MB")
          EOF

      - name: ‚¨áÔ∏è Download Phi-3 Mini 3.8B
        if: ${{ inputs.model_name == 'phi-3-mini' || inputs.model_name == 'all' }}
        run: |
          python - <<'EOF'
          from huggingface_hub import hf_hub_download
          import os
          print("üì• Downloading Phi-3 Mini 4K Instruct Q4...")
          file_path = hf_hub_download(
              repo_id="microsoft/Phi-3-mini-4k-instruct-gguf",
              filename="Phi-3-mini-4k-instruct-q4.gguf",
              local_dir="${{ env.MODELS_DIR }}",
              local_dir_use_symlinks=False
          )
          print(f"‚úÖ Downloaded to: {file_path}")
          print(f"üìä Size: {os.path.getsize(file_path) / (1024*1024):.2f} MB")
          EOF

      - name: üìä Verify downloaded models
        run: |
          echo "üìÅ Downloaded models:"
          ls -lh ${{ env.MODELS_DIR }}
          echo ""
          echo "üíæ Total size:"
          du -sh ${{ env.MODELS_DIR }}

      - name: üíæ Commit models to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ${{ env.MODELS_DIR }}
          git add -A
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            git commit -m "Add ML models for build - Model: ${{ inputs.model_name }}, Profile: ${{ inputs.profile }}"
            git push
            echo "‚úÖ Models committed and pushed"
          fi

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: üîß Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üì¶ Install dependencies
        run: bun install --frozen-lockfile

      - name: üèóÔ∏è Build iOS with EAS
        run: |
          echo "üöÄ Starting EAS Build for iOS..."
          echo "Profile: ${{ inputs.profile }}"
          echo "This build includes model: ${{ inputs.model_name }}"

          eas build \
            --platform ios \
            --profile ${{ inputs.profile }} \
            --non-interactive \
            --wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: üìã Get build information
        id: build_info
        run: |
          set +e

          echo "‚è≥ Waiting for EAS to process build metadata..."
          sleep 10

          echo "üîç Attempting to retrieve build information..."
          BUILD_LIST=$(eas build:list --platform ios --limit 1 --json 2>&1)
          EXIT_CODE=$?

          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå EAS build:list failed with exit code $EXIT_CODE"
            echo "üìã Error output: $BUILD_LIST"
            echo "build_id=unknown" >> $GITHUB_OUTPUT
            echo "build_url=unknown" >> $GITHUB_OUTPUT
          elif [ -z "$BUILD_LIST" ]; then
            echo "‚ö†Ô∏è No build list returned"
            echo "build_id=unknown" >> $GITHUB_OUTPUT
            echo "build_url=unknown" >> $GITHUB_OUTPUT
          elif ! echo "$BUILD_LIST" | jq -e '.' >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Build list is not valid JSON"
            echo "üìã Output: $BUILD_LIST"
            echo "build_id=unknown" >> $GITHUB_OUTPUT
            echo "build_url=unknown" >> $GITHUB_OUTPUT
          else
            BUILD_ID=$(echo "$BUILD_LIST" | jq -r '.[0].id // empty')
            BUILD_URL=$(echo "$BUILD_LIST" | jq -r '.[0].artifacts.buildUrl // empty')

            if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" == "null" ]; then
              echo "‚ö†Ô∏è Could not extract build ID from response"
              echo "build_id=unknown" >> $GITHUB_OUTPUT
              echo "build_url=unknown" >> $GITHUB_OUTPUT
            else
              echo "build_id=${BUILD_ID}" >> $GITHUB_OUTPUT
              echo "build_url=${BUILD_URL}" >> $GITHUB_OUTPUT
              echo "‚úÖ Build ID: ${BUILD_ID}"
              echo "üîó Build URL: ${BUILD_URL}"
            fi
          fi

          set -e
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ‚úÖ Deployment Summary
        run: |
          echo "================================================"
          echo "‚úÖ BUILD COMPLETE AND READY FOR VIBECODE"
          echo "================================================"
          echo ""
          echo "üì¶ Model: ${{ inputs.model_name }}"
          echo "üè∑Ô∏è Profile: ${{ inputs.profile }}"
          echo "üÜî Build ID: ${{ steps.build_info.outputs.build_id }}"
          echo ""
          echo "üì• NEXT STEPS IN VIBECODE:"
          echo "1. Pull the repository:"
          echo "   git pull origin main"
          echo ""
          echo "2. The build is complete! Submit to App Store:"
          echo "   eas submit --platform ios --latest"
          echo ""
          echo "   Or submit specific build:"
          echo "   eas submit --platform ios --id ${{ steps.build_info.outputs.build_id }}"
          echo ""
          echo "================================================"
          echo "üîó View build: https://expo.dev/accounts/$(eas whoami)/builds/${{ steps.build_info.outputs.build_id }}"
          echo "================================================"

      - name: üí¨ Create deployment summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## üöÄ Build Complete - Ready for Vibecode Deployment

          **Status:** ‚úÖ Build finished successfully
          **Model:** ${{ inputs.model_name }}
          **Profile:** ${{ inputs.profile }}
          **Build ID:** ${{ steps.build_info.outputs.build_id }}

          ### üì• Deploy from Vibecode

          \`\`\`bash
          # 1. Pull the latest code (includes models)
          git pull origin main

          # 2. Submit to App Store
          eas submit --platform ios --latest

          # Or submit specific build:
          eas submit --platform ios --id ${{ steps.build_info.outputs.build_id }}
          \`\`\`

          ### üîó Links
          - [View Build Details](${{ steps.build_info.outputs.build_url }})
          - [EAS Dashboard](https://expo.dev)

          ---
          *Build triggered by workflow: ${{ github.workflow }}*
          EOF
